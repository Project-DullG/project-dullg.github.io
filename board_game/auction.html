<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 방장(auction.html)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- Firebase (웹 클라이언트 전용) -->
<script type="module" id="fb-sdk">
  // ✅ 네가 제공한 Firebase 구성값
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };

  // SDK 로드 & 전역 주입
  const ready = (async () => {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    // (선택) Analytics
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch(_) {}

    window.__fb = { app, ...fs, ...au };
  })();

  // 외부에서 await 할 수 있게 노출
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-3xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 방장</span></h1>
    <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 준비중…</span>
  </header>

  <!-- 1) 방장: 방 만들기 -->
  <section id="view-create" class="bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">방 만들기</h2>
    <label class="text-sm block mb-1">내 닉네임(방장)</label>
    <input id="host-name" type="text" placeholder="예: 상회장" class="w-full border rounded px-3 py-2 mb-3" />
    <button id="btn-create" type="button" class="btn w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2" disabled>
      방 만들기
    </button>
    <p class="text-xs text-slate-500 mt-3">이 페이지는 <b>방장 전용</b>입니다. 방을 만든 뒤 링크를 참가자에게 공유하세요.</p>
    <div id="err-create" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 2) 방장: 로비(공유/대기/시작) -->
  <section id="view-host" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">Room <span id="room-id" class="mono"></span></h2>
      <div class="text-sm">참가자 <span id="count" class="font-bold">0</span> / 6</div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div class="border rounded-lg p-4">
        <h3 class="font-semibold mb-2">참가 링크 공유</h3>
        <div class="flex items-center gap-2">
          <input id="share-link" class="w-full border rounded px-3 py-2 text-xs" readonly />
          <button id="btn-copy" type="button" class="btn bg-slate-800 text-white rounded px-3 py-2">복사</button>
        </div>
        <canvas id="qr" class="mx-auto mt-3"></canvas>
        <p class="text-xs text-slate-500 mt-2">최대 6명 접속. <b>3명 이상</b> 모이면 <b>시작</b> 활성화.</p>
      </div>

      <div class="border rounded-lg p-4">
        <h3 class="font-semibold mb-2">대기 중 참가자</h3>
        <ul id="wait-list" class="space-y-2 text-sm"></ul>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <button id="btn-start" type="button" class="btn bg-indigo-600 disabled:bg-indigo-600/50 text-white rounded px-4 py-2" disabled>
        시작하기
      </button>
      <span class="text-xs text-slate-600">3–6명에서 시작 가능</span>
    </div>

    <div id="err-host" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 3) (옵션) 시작 후 안내 -->
  <section id="view-started" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-2">게임 시작!</h2>
    <p class="text-sm text-slate-600">본 게임 화면은 별도 페이지로 구성 예정입니다.</p>
  </section>

</div>

<script type="module">
  // ---------- 공통 ----------
  const $ = s => document.querySelector(s);
  const show = (id, yes) => $(id).classList.toggle("hidden", !yes);
  const setBadge = (t, cls) => { const b=$("#badge"); b.textContent=t; b.className=`text-xs px-2 py-1 rounded ${cls}`; };
  const randId = (len=6) => { const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s=""; for(let i=0;i<len;i++) s+=A[Math.floor(Math.random()*A.length)]; return s; };

  await window.firebaseReady;
  const {
    getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp,
    getAuth, signInAnonymously
  } = window.__fb;
  const db = getFirestore();
  const auth = getAuth();

  async function ensureAuth() {
    if (auth.currentUser) return;
    await signInAnonymously(auth);
  }

  function showErr(selector, msg) {
    const box = $(selector);
    box.textContent = msg;
    box.classList.remove("hidden");
  }

  // 최초 연결 시도
  try { await ensureAuth(); setBadge("연결됨", "bg-indigo-600 text-white"); }
  catch(e){ setBadge("연결 실패", "bg-rose-600 text-white"); showErr("#err-create", `익명 로그인 실패: ${e.code||""} ${e.message||""}`); }

  // 기본 상태: 방 만들기 버튼 활성화
  $("#btn-create").disabled = false;

  // ---------- 방 생성 ----------
  $("#btn-create").addEventListener("click", async () => {
    const name = ($("#host-name").value||"").trim();
    if (!name) return showErr("#err-create", "닉네임을 입력하세요.");

    const roomId = randId();
    // 참가자 페이지를 join.html로 분리한다고 가정
    const joinUrl = new URL("join.html", location.href);
    joinUrl.searchParams.set("room", roomId);

    const roomDoc = {
      id: roomId,
      hostName: name,
      link: joinUrl.toString(),
      players: [],        // 참가자는 join.html에서 push
      started: false,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    try {
      await ensureAuth();
      await setDoc(doc(db,"rooms",roomId), roomDoc);

      // 방장 로비 전환
      $("#room-id").textContent = roomId;
      $("#share-link").value    = joinUrl.toString();
      QRCode.toCanvas($("#qr"), joinUrl.toString(), { width: 180 });

      show("#view-create", false);
      show("#view-host",   true);

      // 실시간 참가자 구독 & 시작 버튼 조건
      const ref = doc(db,"rooms",roomId);
      onSnapshot(ref, (snap)=>{
        if (!snap.exists()) return;
        const r = snap.data();
        const list = r.players || [];
        renderWaitList(list);
        $("#count").textContent = list.length;
        $("#btn-start").disabled = !(list.length >= 3 && list.length <= 6);
        if (r.started) {
          // 이미 시작 상태면 안내 화면으로
          show("#view-host", false);
          show("#view-started", true);
        }
      });

      // 링크 복사
      $("#btn-copy").onclick = async () => {
        try {
          await navigator.clipboard.writeText(joinUrl.toString());
          $("#btn-copy").textContent = "복사됨!";
          setTimeout(()=>$("#btn-copy").textContent="복사", 1200);
        } catch(e) {
          showErr("#err-host", `복사 실패: ${e.message||e}`);
        }
      };

      // 시작
      $("#btn-start").onclick = async () => {
        try {
          const snap = await getDoc(ref);
          const r = snap.data();
          const n = (r.players||[]).length;
          if (n < 3 || n > 6) return; // 가드
          await updateDoc(ref, { started: true, updatedAt: serverTimestamp() });
          show("#view-host", false);
          show("#view-started", true);
        } catch(e) {
          showErr("#err-host", `시작 실패: ${e.code||""} ${e.message||""}`);
        }
      };

    } catch(e) {
      showErr("#err-create", `방 생성 실패: ${e.code||""} ${e.message||""}\n(익명 로그인, Authorized domains, Firestore 규칙 확인)`);
      console.error(e);
    }
  });

  function renderWaitList(players){
    const ul = $("#wait-list"); ul.innerHTML="";
    players.forEach((p,i)=>{
      const li = document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.innerHTML = `<span>${i+1}. ${p.name}</span>`;
      ul.appendChild(li);
    });
  }
</script>
</body>
</html>
