<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 로비(간략)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- Firebase (웹 클라이언트 전용) -->
<script type="module" id="fb-sdk">
  // ▶ 이미 발급받은 구성값 (필요 시 교체)
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };

  // SDK 로드 & 전역 주입
  const ready = (async () => {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-3xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 로비</span></h1>
    <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 준비중…</span>
  </header>

  <!-- 방장: 방 만들기 -->
  <section id="view-create" class="bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">방장 · 방 만들기</h2>
    <label class="text-sm block mb-1">내 닉네임(방장)</label>
    <input id="host-name" type="text" placeholder="예: 상회장" class="w-full border rounded px-3 py-2 mb-3" />
    <button id="btn-create" class="btn w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2" disabled>
      방 만들기
    </button>
    <p class="text-xs text-slate-500 mt-3">
      이 페이지(보통 QR로 접속)는 <b>방장 전용</b>입니다. 방을 만든 뒤 링크를 복사해 참가자에게 보내세요.
    </p>
    <div id="err-create" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 방장: 공유/대기실 -->
  <section id="view-host" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">Room <span id="room-id" class="mono"></span></h2>
      <div class="text-sm">참가자 <span id="count" class="font-bold">0</span> / 6</div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div class="border rounded-lg p-4">
        <h3 class="font-semibold mb-2">참가 링크 공유</h3>
        <div class="flex items-center gap-2">
          <input id="share-link" class="w-full border rounded px-3 py-2 text-xs" readonly />
          <button id="btn-copy" class="btn bg-slate-800 text-white rounded px-3 py-2">복사</button>
        </div>
        <canvas id="qr" class="mx-auto mt-3"></canvas>
        <p class="text-xs text-slate-500 mt-2">링크 최대 <b>6명</b>까지 접속 가능. <b>3명 이상</b> 모이면 시작 버튼이 활성화됩니다.</p>
      </div>

      <div class="border rounded-lg p-4">
        <h3 class="font-semibold mb-2">대기 중 참가자</h3>
        <ul id="wait-list" class="space-y-2 text-sm"></ul>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <button id="btn-start" class="btn bg-indigo-600 disabled:bg-indigo-600/50 text-white rounded px-4 py-2" disabled>
        시작하기
      </button>
      <span id="hint" class="text-xs text-slate-600">3–6명에서 시작 가능</span>
    </div>
  </section>

  <!-- 참가자: 닉네임 입력 → 입장 -->
  <section id="view-join" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">참가하기</h2>
    <div class="text-sm mb-2">Room <span id="join-room" class="mono"></span></div>
    <label class="text-sm block mb-1">내 닉네임</label>
    <input id="join-name" type="text" placeholder="예: 탐험가" class="w-full border rounded px-3 py-2 mb-3" />
    <button id="btn-join" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2" disabled>
      입장
    </button>
    <p class="text-xs text-slate-500 mt-3">정원: 최소 3명, 최대 6명</p>
    <div id="err-join" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 참가자/방장 공통: 대기실 뷰(간단) -->
  <section id="view-lobby" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">대기실</h2>
    <div class="text-sm">Room <span id="lobby-room" class="mono"></span> · 현재 <span id="lobby-count" class="font-bold">0</span>/6</div>
    <ul id="lobby-list" class="mt-3 space-y-2 text-sm"></ul>
    <div id="lobby-started" class="hidden mt-4 p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm">
      게임이 시작되었습니다! (여기서부터의 본 게임 화면은 다음 단계에서 붙입니다)
    </div>
  </section>

</div>

<script type="module">
  // ------- 준비/공통 -------
  const $ = s => document.querySelector(s);
  const show = (id, yes) => $(id).classList.toggle("hidden", !yes);
  const setBadge = (t, cls) => { const b=$("#badge"); b.textContent=t; b.className=`text-xs px-2 py-1 rounded ${cls}`; };
  const randId = (len=6) => {
    const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s="";
    for (let i=0;i<len;i++) s+=A[Math.floor(Math.random()*A.length)]; return s;
  };

  await window.firebaseReady;
  const {
    getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp,
    getAuth, signInAnonymously
  } = window.__fb;
  const db = getFirestore();
  const auth = getAuth();
  try { await signInAnonymously(auth); setBadge("연결됨", "bg-indigo-600 text-white"); }
  catch(e){ setBadge("연결 실패", "bg-rose-600 text-white"); }

  // ------- 라우팅: #join=ROOM 이면 참가 뷰로 -------
  function handleRoute() {
    const h = location.hash.replace(/^#/, "");
    if (h.startsWith("join=")) {
      const roomId = h.split("=")[1];
      $("#join-room").textContent = roomId;
      show("#view-create", false);
      show("#view-host",   false);
      show("#view-join",   true);
      show("#view-lobby",  false);
      // 버튼 활성화
      $("#btn-join").disabled = false;
    } else {
      // 기본: 방장 생성 화면
      show("#view-create", true);
      show("#view-host",   false);
      show("#view-join",   false);
      show("#view-lobby",  false);
      $("#btn-create").disabled = false;
    }
  }
  window.addEventListener("hashchange", handleRoute);
  handleRoute();

  // ------- 방 생성(방장) -------
  $("#btn-create").addEventListener("click", async () => {
    const name = ($("#host-name").value||"").trim();
    if (!name) return ($("#err-create").textContent="닉네임을 입력하세요.", $("#err-create").classList.remove("hidden"));

    const roomId = randId();
    const link   = `${location.origin}${location.pathname}#join=${roomId}`;
    const room = { id: roomId, hostName: name, link, players: [], started: false,
                   createdAt: serverTimestamp(), updatedAt: serverTimestamp() };

    try {
      await setDoc(doc(db,"rooms",roomId), room);
      // 호스트 화면으로
      $("#room-id").textContent = roomId;
      $("#share-link").value    = link;
      QRCode.toCanvas($("#qr"), link, { width: 160 });
      show("#view-create", false);
      show("#view-host",   true);
      // 실시간 참가자 목록
      onSnapshot(doc(db,"rooms",roomId), (snap)=>{
        if (!snap.exists()) return;
        const r = snap.data();
        renderWaitList(r.players||[]);
        $("#count").textContent = (r.players||[]).length;
        $("#lobby-count").textContent = (r.players||[]).length;
        // 시작 버튼 조건(3~6명)
        $("#btn-start").disabled = !((r.players||[]).length >=3 && (r.players||[]).length <=6);
      });
      // 복사 버튼
      $("#btn-copy").onclick = async () => {
        await navigator.clipboard.writeText(link);
        $("#btn-copy").textContent = "복사됨!";
        setTimeout(()=>$("#btn-copy").textContent="복사", 1200);
      };
      // 시작 버튼 (여기선 started=true만 기록)
      $("#btn-start").onclick = async () => {
        const ref = doc(db,"rooms",roomId);
        const snap = await getDoc(ref); const r=snap.data();
        const n = (r.players||[]).length;
        if (n<3 || n>6) return; // 가드
        await updateDoc(ref, { started:true, updatedAt: serverTimestamp() });
        // 간단한 대기실로 전환(호스트 포함 공통)
        $("#lobby-room").textContent = roomId;
        show("#view-host", false);
        show("#view-lobby", true);
        $("#lobby-started").classList.remove("hidden");
        onSnapshot(ref, s=>{
          const rr = s.data();
          renderLobby(rr.players||[]);
        });
      };
    } catch(e) {
      $("#err-create").textContent = "방 생성 실패: Firestore 규칙/도메인/인증 설정을 확인하세요.";
      $("#err-create").classList.remove("hidden");
      console.error(e);
    }
  });

  function renderWaitList(players){
    const ul = $("#wait-list"); ul.innerHTML="";
    players.forEach((p,i)=>{
      const li = document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.innerHTML = `<span>${i+1}. ${p.name}</span>`;
      ul.appendChild(li);
    });
  }

  // ------- 참가(링크로 접속한 플레이어) -------
  $("#btn-join").addEventListener("click", async ()=>{
    const roomId = $("#join-room").textContent.trim();
    const name   = ($("#join-name").value||"").trim();
    if (!name)   return ($("#err-join").textContent="닉네임을 입력하세요.", $("#err-join").classList.remove("hidden"));

    try{
      const ref = doc(db,"rooms",roomId);
      const snap = await getDoc(ref);
      if (!snap.exists()) throw new Error("존재하지 않는 방입니다.");
      const r = snap.data();
      const players = r.players || [];

      if (players.length >= 6) throw new Error("정원이 가득 찼습니다(6명).");
      if (players.some(p=>p.name===name)) throw new Error("같은 닉네임이 이미 존재합니다.");

      players.push({ id:`P${players.length+1}`, name });
      await updateDoc(ref, { players, updatedAt: serverTimestamp() });

      // 공통 대기실로
      $("#lobby-room").textContent = roomId;
      show("#view-join", false);
      show("#view-lobby", true);

      onSnapshot(ref, s=>{
        const rr = s.data();
        $("#lobby-count").textContent = (rr.players||[]).length;
        renderLobby(rr.players||[]);
        if (rr.started) $("#lobby-started").classList.remove("hidden");
      });

    }catch(e){
      $("#err-join").textContent = e.message || "입장 실패";
      $("#err-join").classList.remove("hidden");
      console.error(e);
    }
  });

  function renderLobby(players){
    const ul = $("#lobby-list"); ul.innerHTML="";
    players.forEach((p,i)=>{
      const li = document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.innerHTML = `<span>${i+1}. ${p.name}</span>`;
      ul.appendChild(li);
    });
  }
</script>
</body>
</html>
