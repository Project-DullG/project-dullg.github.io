<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 방장(room) + 빠른 재입장</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase (모듈) -->
<script type="module" id="fb-sdk">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };

  const ready = (async () => {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-3xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 방</span></h1>
    <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 준비중…</span>
  </header>

  <!-- 빠른 재입장 -->
  <section id="view-quick" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">빠른 재입장</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <div class="text-sm text-slate-600">최근/대상 방 코드</div>
        <div class="mt-1">
          <input id="quickRoom" class="w-full border rounded px-3 py-2 mono" readonly />
        </div>
        <p class="text-xs text-slate-500 mt-2">URL의 <code>?room=</code> 파라미터나, 기기에 저장된 마지막 방 코드가 자동 표시됩니다.</p>
      </div>
      <div>
        <label class="text-sm block mb-1">내 닉네임</label>
        <input id="quickNick" type="text" placeholder="예: 탐험가" class="w-full border rounded px-3 py-2" />
        <button id="btnQuickJoin" class="btn mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2" disabled>
          해당 방으로 입장
        </button>
      </div>
    </div>
    <div id="errQuick" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 방 만들기 -->
  <section id="view-create" class="bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">새 방 만들기</h2>
    <label class="text-sm block mb-1">내 닉네임(방장)</label>
    <input id="hostName" type="text" placeholder="예: 상회장" class="w-full border rounded px-3 py-2 mb-3" />
    <button id="btnCreate" class="btn w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2" disabled>
      방 만들기
    </button>
    <div id="errCreate" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 공유/대기 (방장 화면) -->
  <section id="view-host" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">Room <span id="roomId" class="mono"></span></h2>
      <div class="text-sm">참가자 <span id="count" class="font-bold">0</span> / 6</div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div class="border rounded-lg p-4">
        <h3 class="font-semibold mb-2">참가 링크 공유</h3>
        <div class="flex items-center gap-2">
          <input id="shareLink" class="w-full border rounded px-3 py-2 text-xs" readonly />
          <button id="btnCopy" class="btn bg-slate-800 text-white rounded px-3 py-2">복사</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">최대 6명 접속. <b>3명 이상</b>이면 시작 가능.</p>
      </div>

      <div class="border rounded-lg p-4">
        <h3 class="font-semibold mb-2">대기 중 참가자</h3>
        <ul id="waitList" class="space-y-2 text-sm"></ul>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <button id="btnStart" class="btn bg-indigo-600 disabled:bg-indigo-600/50 text-white rounded px-4 py-2" disabled>
        시작하기
      </button>
      <span class="text-xs text-slate-600">3–6명에서 시작 가능</span>
    </div>

    <div id="errHost" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>
</div>

<script type="module">
  const $ = s => document.querySelector(s);
  const show = (sel, yes) => $(sel).classList.toggle("hidden", !yes);
  const setBadge=(t,c)=>{const b=$("#badge");b.textContent=t;b.className=`text-xs px-2 py-1 rounded ${c}`};
  const randId = (n=6)=>{const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let s="";for(let i=0;i<n;i++)s+=A[Math.floor(Math.random()*A.length)];return s};

  await window.firebaseReady;
  const { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp,
          getAuth, signInAnonymously } = window.__fb;
  const db=getFirestore(), auth=getAuth();
  async function ensureAuth(){ if(!auth.currentUser) await signInAnonymously(auth) }

  // 연결
  try{ await ensureAuth(); setBadge("연결됨","bg-indigo-600 text-white"); $("#btnCreate").disabled=false; }
  catch{ setBadge("연결 실패","bg-rose-600 text-white"); }

  // ===== 빠른 재입장 모드 =====
  const params=new URL(location.href).searchParams;
  const paramRoom=(params.get("room")||"").toUpperCase();
  const storedRoom=(localStorage.getItem("lastRoom")||"").toUpperCase();
  const quickRoom = paramRoom || storedRoom;

  if (quickRoom) {
    $("#quickRoom").value = quickRoom;
    show("#view-quick", true);
  }

  function refreshQuickBtn() {
    const nameOk = ($("#quickNick").value||"").trim().length>0;
    const roomOk = ($("#quickRoom").value||"").trim().length>0;
    $("#btnQuickJoin").disabled = !(nameOk && roomOk);
  }
  $("#quickNick").addEventListener("input", refreshQuickBtn);
  refreshQuickBtn();

  $("#btnQuickJoin").addEventListener("click", async ()=>{
    const name = ($("#quickNick").value||"").trim();
    const roomId = ($("#quickRoom").value||"").trim().toUpperCase();
    if(!name || !roomId) return;

    try{
      await ensureAuth();
      const ref = doc(db,"rooms",roomId);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error("해당 방이 존재하지 않습니다.");

      const r = snap.data();
      let players = Array.isArray(r.players) ? [...r.players] : [];

      // 이미 동일 닉네임이 있으면 바로 게임으로
      if (players.some(p=>p.name===name)) {
        const gameUrl = new URL("game.html", location.href);
        gameUrl.searchParams.set("room", roomId);
        gameUrl.searchParams.set("name", name);
        location.href = gameUrl.toString();
        return;
      }

      // 새로 추가 (정원 확인)
      if (players.length >= 6) throw new Error("정원이 가득 찼습니다(6명). 다른 닉네임으로 시도하거나 방장을 통해 새 방을 만들어 주세요.");

      players.push({
        id: `P${players.length+1}`,
        name,
        balance: 1000000, // 시작 소지금
        hold: 0,
        bid: 0,
        committed: false,
        readyPart: false,
        readyBid: false,
        willParticipate: null,
        items: []
      });

      await updateDoc(ref, { players, updatedAt: serverTimestamp() });

      // 게임으로 이동 (시작 전이면 choose 단계에서 대기하게 됨)
      const gameUrl = new URL("game.html", location.href);
      gameUrl.searchParams.set("room", roomId);
      gameUrl.searchParams.set("name", name);
      location.href = gameUrl.toString();
    }catch(e){
      const box=$("#errQuick"); box.textContent = `입장 실패: ${e.message||e}`; box.classList.remove("hidden");
    }
  });

  // ===== 방 만들기 =====
  $("#btnCreate").addEventListener("click", async ()=>{
    const name = ($("#hostName").value||"").trim();
    if(!name){ const e=$("#errCreate"); e.textContent="닉네임을 입력하세요."; e.classList.remove("hidden"); return; }

    const roomId = randId();
    const joinUrl = new URL("join.html", location.href); joinUrl.searchParams.set("room", roomId);

    // 방장도 참가자 포함(P1), 기본금 100만원
    const room = {
      id: roomId,
      hostName: name,
      link: joinUrl.toString(),
      started: false,
      round: 0,
      stipend: 200000, // (현재 게임 규칙에서 사용하지 않더라도 남겨둠)
      players: [
        {
          id: "P1",
          name: name,
          balance: 1000000,
          hold: 0,
          bid: 0,
          committed: false,
          readyPart: false,
          readyBid: false,
          willParticipate: null,
          items: []
        }
      ],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    try{
      await ensureAuth();
      await setDoc(doc(db,"rooms",roomId), room);

      // 최근 방 코드 저장 → 빠른 재입장에 활용
      localStorage.setItem("lastRoom", roomId);

      // 호스트 화면 전환
      $("#roomId").textContent = roomId;
      $("#shareLink").value = joinUrl.toString();
      show("#view-create", false);
      show("#view-host", true);

      const ref = doc(db,"rooms",roomId);
      onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;
        const r=snap.data(); const list=r.players||[];
        const ul=$("#waitList"); ul.innerHTML="";
        list.forEach((p,i)=>{
          const li=document.createElement("li");
          li.className="flex items-center justify-between border rounded px-3 py-2";
          li.innerHTML=`<span>${i+1}. ${p.name}</span>`;
          ul.appendChild(li);
        });
        $("#count").textContent=list.length;
        $("#btnStart").disabled=!(list.length>=3 && list.length<=6);
      });

      $("#btnCopy").onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(joinUrl.toString());
          const btn=$("#btnCopy"); btn.textContent="복사됨!"; setTimeout(()=>btn.textContent="복사",1200);
        }catch(e){
          const b=$("#errHost"); b.textContent=`복사 실패: ${e.message||e}`; b.classList.remove("hidden");
        }
      };

      $("#btnStart").onclick = async ()=>{
        try{
          const ref=doc(db,"rooms",roomId);
          const snap=await getDoc(ref); const r=snap.data(); const n=(r.players||[]).length;
          if(n<3 || n>6) return; // 가드
          await updateDoc(ref,{ started:true, updatedAt:serverTimestamp() });
          // 게임 페이지로 이동
          const gameUrl = new URL("game.html", location.href);
          gameUrl.searchParams.set("room", roomId);
          gameUrl.searchParams.set("name", name);
          location.href = gameUrl.toString();
        }catch(e){
          const b=$("#errHost"); b.textContent=`시작 실패: ${e.message||e}`; b.classList.remove("hidden");
        }
      };

    }catch(e){
      const box=$("#errCreate"); box.textContent=`방 생성 실패: ${e.code||""} ${e.message||e}`; box.classList.remove("hidden");
    }
  });
</script>
</body>
</html>
