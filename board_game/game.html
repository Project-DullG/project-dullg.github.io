<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 게임(game)</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module" id="fb-sdk">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };
  const ready=(async()=>{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .badge{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem}
  .card{background:#fff;border-radius:1rem;box-shadow:0 1px 3px rgb(0 0 0 / .06),0 1px 2px rgb(0 0 0 / .04)}
  .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom,0) + 72px);}
</style>
</head>
<body class="bg-slate-50 text-slate-900 safe-bottom">
<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 게임</span></h1>
      <div class="text-sm text-slate-600 mt-1">
        Room <span id="roomId" class="mono">—</span> · Round <span id="round" class="mono">0</span>
        · You: <span id="you" class="font-medium"></span>
        · Role: <span id="role" class="font-medium">guest</span>
      </div>
    </div>
    <span id="badge" class="badge bg-slate-200">연결 준비중…</span>
  </header>

  <div id="endedBox" class="hidden p-4 rounded border bg-emerald-50 border-emerald-200 text-emerald-800 text-sm">
    <span id="endMsg">게임이 종료되었습니다.</span>
  </div>

  <div id="grid" class="grid gap-4 lg:grid-cols-12">

    <!-- 내 정보 + 단계별 액션 -->
    <section id="panelMe" class="card p-4 md:p-6 lg:col-span-5 xl:col-span-4">
      <h2 class="font-semibold mb-3">내 정보</h2>
      <div class="text-sm">닉네임: <span id="myName" class="font-medium"></span></div>
      <div class="text-sm mt-1">소지금: <span id="myBalance" class="mono font-bold">0</span>원</div>
      <div class="text-sm mt-1">보류금(확정된 입찰): <span id="myHold" class="mono font-bold">0</span>원</div>

      <hr class="my-4">

      <!-- 1단계: 응찰 선택 -->
      <div id="phaseChoose" class="space-y-3">
        <h3 class="font-semibold">1) 응찰 여부 선택</h3>
        <div class="text-sm">이번 상품: <b id="currentItemMe">-</b></div>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="part" value="yes" /> 응찰 참여
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="part" value="no" /> 불응찰(+50,000원)
          </label>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnLockPart" class="btn bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">응찰 확정</button>
          <span id="partStatus" class="badge bg-slate-100">미확정</span>
        </div>
        <p class="text-xs text-slate-500">※ 불응찰 확정 시 이번 라운드 입찰은 불가하며 즉시 50,000원이 지급됩니다.</p>
      </div>

      <!-- 2단계: 입찰 (데스크톱용) -->
      <div id="phaseBid" class="hidden space-y-3">
        <h3 class="font-semibold">2) 비공개 입찰</h3>
        <div class="text-sm">이번 상품: <b id="currentItemBid">-</b></div>
        <div id="bidDisabled" class="hidden text-sm text-slate-500">이번 라운드 불응찰을 선택하여 입찰할 수 없습니다.</div>

        <div id="bidBox" class="hidden">
          <div class="flex items-center gap-2 mb-2 flex-wrap">
            <button data-step="-5" class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm" id="btnMinus5">-5단위</button>
            <button data-step="-1" class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm" id="btnMinus1">-1단위</button>
            <input id="bidInput" inputmode="numeric" class="mono w-36 md:w-44 border rounded px-3 py-2 text-right" placeholder="0" aria-label="입찰 금액(원)" />
            <button data-step="1"  class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm" id="btnPlus1">+1단위</button>
            <button data-step="5"  class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm" id="btnPlus5">+5단위</button>
          </div>
          <div class="text-xs text-slate-500 -mt-1 mb-2">※ 단위는 방장이 설정한 입찰 단위를 따릅니다.</div>
          <div class="flex items-center gap-2">
            <button id="btnConfirmBid"  class="btn bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">입찰 확정</button>
            <button id="btnCancelBid"   class="btn bg-slate-300 hover:bg-slate-400 rounded px-4 py-2">입찰 취소</button>
            <span id="bidStatus" class="badge bg-slate-100">대기중</span>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <h3 class="font-semibold mb-2">내 소지품</h3>
      <ul id="myItems" class="mt-2 space-y-2 text-sm"></ul>

      <div class="mt-4 p-3 rounded border bg-slate-50 text-sm">
        <div class="font-semibold mb-1">승리 조건</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>모두 같은 재료 <b>3개</b></li>
          <li>모두 다른 재료 <b>4개</b></li>
          <li>재료 <b>5개</b></li>
        </ul>
      </div>
    </section>

    <!-- 공개 정보 -->
    <section id="panelPublic" class="card p-4 md:p-6 lg:col-span-7 xl:col-span-5">
      <h2 class="font-semibold mb-3">라운드 정보</h2>
      <div class="text-sm text-slate-600 mb-2">
        라운드 단계: <b id="phaseText">-</b> · 이번 상품: <b id="currentItem">-</b> · 최근 상품: <b id="lastItem">-</b>
      </div>

      <!-- 응찰자 공개 -->
      <div id="revealBox" class="hidden">
        <h3 class="font-semibold mb-2">이번 라운드 응찰자</h3>
        <ul id="participantList" class="space-y-2 text-sm"></ul>
        <p class="text-xs text-slate-500 mt-2">※ 응찰자 명단만 공개됩니다. 낙찰자/입찰액은 공개되지 않습니다.</p>
      </div>

      <h3 class="font-semibold mt-6 mb-2">플레이어 현황</h3>
      <ul id="players" class="space-y-2 text-sm"></ul>
      <div class="text-xs text-slate-500 mt-2">※ 잔액은 각자만 확인합니다.</div>
    </section>

    <!-- 방장 컨트롤 -->
    <section id="hostPanel" class="hidden card p-4 md:p-6 lg:col-span-3 xl:col-span-3">
      <h2 class="font-semibold mb-3">방장 컨트롤</h2>

      <!-- 재료 선택 -->
      <label class="text-sm block mb-1">이번 상품</label>
      <div class="flex items-center gap-2 mb-3">
        <select id="roundItem" class="w-full border rounded px-3 py-2">
          <option value="">— 선택 —</option>
          <option>오징어</option>
          <option>독도새우</option>
          <option>호박</option>
          <option>명이나물</option>
        </select>
        <button id="btnRandom" class="btn bg-slate-200 rounded px-3 py-2">랜덤</button>
      </div>

      <!-- 입찰 단위 -->
      <label class="text-sm block mb-1">입찰 단위</label>
      <select id="bidStep" class="w-full border rounded px-3 py-2 mb-3">
        <option value="10000">1만 원</option>
        <option value="50000">5만 원</option>
        <option value="100000">10만 원</option>
      </select>
      <div class="text-xs text-slate-500 mb-3">플러스/마이너스 버튼과 금액 반올림에 적용됩니다.</div>

      <!-- 라운드 컨트롤 -->
      <button id="btnStartRound" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2 mb-2">
        라운드 시작(응찰 단계로)
      </button>

      <div class="text-xs text-slate-500 mb-2">모두가 응찰 확정하면 공개 후 입찰 단계로 넘어갑니다.</div>
      <button id="btnReveal" class="btn w-full bg-amber-600 hover:bg-amber-700 text-white rounded px-4 py-2 mb-2" disabled>
        참여 인원 공개(→입찰 단계)
      </button>

      <div class="text-xs text-slate-500 mb-2">입찰 참여자 전원이 입찰 확정/취소를 마치면 정산 가능합니다.</div>
      <button id="btnEndRound" class="btn w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2" disabled>
        라운드 종료(정산)
      </button>

      <hr class="my-4">
      <button id="btnEndGame" class="btn w-full bg-rose-600 hover:bg-rose-700 text-white rounded px-4 py-2">
        게임 종료(방 삭제)
      </button>

      <div id="errHost" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
    </section>
  </div>

  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded z-40">
    <span id="toastMsg"></span>
  </div>
</div>

<!-- 모바일 하단 입찰 바 -->
<div id="mobileBidBar" class="md:hidden fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t shadow-lg z-50 hidden">
  <div class="max-w-7xl mx-auto px-3 py-2">
    <div class="text-xs text-slate-600 mb-1">
      이번 상품: <b id="currentItemMobile">-</b> · 단위: <b id="stepMobile">-</b>
    </div>
    <div class="flex items-center gap-2">
      <button data-step="-1" class="flex-1 min-w-[56px] py-2 rounded bg-slate-200 text-xs" id="mMinus1">-1단위</button>
      <input id="bidInputMobile" inputmode="numeric" class="mono w-28 flex-none border rounded px-2 py-2 text-right" placeholder="0" />
      <button data-step="1"  class="flex-1 min-w-[56px] py-2 rounded bg-slate-200 text-xs" id="mPlus1">+1단위</button>
    </div>
    <div class="flex items-center gap-2 mt-2">
      <button id="btnConfirmBidMobile" class="flex-1 py-2 rounded bg-indigo-600 text-white">확정</button>
      <button id="btnCancelBidMobile"  class="flex-1 py-2 rounded bg-slate-300">취소</button>
    </div>
  </div>
</div>

<script type="module">
  const $=s=>document.querySelector(s);
  const fmt=n=>Number(n||0).toLocaleString("ko-KR");
  const show=(sel,yes)=>$(sel).classList.toggle("hidden",!yes);
  const toast=(msg)=>{ $("#toastMsg").textContent=msg; $("#toast").classList.remove("hidden"); setTimeout(()=>$("#toast").classList.add("hidden"), 2000); };

  const params=new URL(location.href).searchParams;
  const roomId=(params.get("room")||"").toUpperCase();
  const myName=(params.get("name")||"").trim();
  $("#roomId").textContent=roomId||"—"; $("#you").textContent=myName||"—"; $("#myName").textContent=myName||"—";

  await window.firebaseReady;
  const { getFirestore, doc, getDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp,
          getAuth, signInAnonymously } = window.__fb;
  const db=getFirestore(), auth=getAuth();
  try{ if(!auth.currentUser) await signInAnonymously(auth);
       $("#badge").textContent="연결됨"; $("#badge").className="badge bg-indigo-600 text-white";
  }catch(e){ $("#badge").textContent="연결 실패"; $("#badge").className="badge bg-rose-600 text-white"; }

  const ref=doc(db,"rooms",roomId);

  // 유틸
  function guessHost(r){
    const a=(r?.hostName||"").trim().toLowerCase();
    const b=(myName||"").trim().toLowerCase();
    const p1=Array.isArray(r?.players)? r.players[0]:null;
    const p1n=(p1?.name||"").trim().toLowerCase();
    return (a&&a===b)||(p1n&&p1n===b);
  }
  function checkWin(items=[]){
    const total=items.length; const c={}; items.forEach(it=>c[it]=(c[it]||0)+1);
    if(total>=5) return "any5";
    if(Object.values(c).some(v=>v>=3)) return "same3";
    if(new Set(items).size>=4) return "diff4";
    return "";
  }
  const ITEMS=["오징어","독도새우","호박","명이나물"];
  const randItem=()=>ITEMS[Math.floor(Math.random()*ITEMS.length)];

  // 상태
  let isHost=false, currentPlayers=[], currentMe=null;
  let lastSeenResultRound=0;
  let bidStep=10000; // 서버 동기화

  // 금액 입력
  let stagedBid=0;
  const bidInput=$("#bidInput");
  const bidInputMobile=$("#bidInputMobile");
  const parseMoney=s=>Number((s||"0").replace(/[^\d]/g,""))||0;
  const snapToStep=n=>Math.floor(Number(n||0)/bidStep)*bidStep;
  function syncBidInputs(){
    const v = snapToStep(stagedBid);
    if(bidInput)       bidInput.value      = v.toLocaleString("ko-KR");
    if(bidInputMobile) bidInputMobile.value= v.toLocaleString("ko-KR");
  }
  function clampToAvail(avail){
    stagedBid=Math.max(0, Math.min(snapToStep(stagedBid), avail));
    syncBidInputs();
  }
  function setStepLabels(){
    $("#btnMinus5").textContent = `-5단위`;
    $("#btnMinus1").textContent = `-1단위`;
    $("#btnPlus1").textContent  = `+1단위`;
    $("#btnPlus5").textContent  = `+5단위`;
    $("#stepMobile").textContent = bidStep.toLocaleString("ko-KR");
  }
  setStepLabels(); syncBidInputs();

  function bindStepButtons(){
    document.querySelectorAll("[data-step]").forEach(btn=>{
      if(btn._bound) return;
      btn._bound=true;
      btn.addEventListener("click", ()=>{
        const factor = Number(btn.getAttribute("data-step")); // -5,-1,1,5
        const delta = factor * bidStep;
        const avail = (currentMe?.balance||0)+(currentMe?.hold||0);
        stagedBid = stagedBid + delta;
        clampToAvail(avail);
      });
    });
  }
  bindStepButtons();

  // 초기
  async function init(){
    const s=await getDoc(ref);
    if(!s.exists()){ endUI("방이 존재하지 않습니다."); return; }
    const r=s.data();
    if(r.gameOver){ endUI("게임이 종료되었습니다.", r.winners||[]); return; }
    isHost=guessHost(r);
    $("#role").textContent=isHost?"host":"guest";
    if(!r.phase){ await updateDoc(ref,{ phase:"choose", updatedAt:serverTimestamp() }); }
  }
  await init();

  function endUI(msg, winners=[]){
    $("#endMsg").textContent = winners.length? `게임 종료! 우승: ${winners.join(", ")}` : msg;
    $("#endedBox").classList.remove("hidden");
    ["btnStartRound","btnReveal","btnEndRound","btnEndGame","btnConfirmBid","btnCancelBid","btnLockPart","roundItem","btnRandom","btnConfirmBidMobile","btnCancelBidMobile","bidStep"]
      .forEach(id=>{ const el=$("#"+id); if(el) el.setAttribute("disabled","true"); });
    show("#mobileBidBar", false);
  }

  // 스냅샷
  onSnapshot(ref, async (s)=>{
    if(!s.exists()){ endUI("방이 종료(삭제)되었습니다."); return; }
    const d=s.data();
    if(d.gameOver){ endUI("게임이 종료되었습니다.", d.winners||[]); }

    $("#round").textContent=d.round??0;
    $("#phaseText").textContent = d.phase==="choose" ? "응찰 선택" :
                                  d.phase==="bid"    ? "비공개 입찰" : "-";
    $("#currentItem").textContent = d.currentItem || "-";
    $("#lastItem").textContent    = d.lastItem || "-";
    $("#currentItemMe").textContent = d.currentItem || "-";
    $("#currentItemBid").textContent= d.currentItem || "-";
    $("#currentItemMobile").textContent = d.currentItem || "-";

    isHost=guessHost(d);
    $("#role").textContent=isHost?"host":"guest";
    if(isHost) { $("#hostPanel").classList.remove("hidden"); } else { $("#hostPanel").classList.add("hidden"); }

    // 입찰 단위 동기화
    bidStep = Number(d.bidStep ?? 10000);
    setStepLabels();

    currentPlayers = Array.isArray(d.players)? d.players : [];
    currentMe = currentPlayers.find(p=>p.name===myName) || null;

    $("#myBalance").textContent = (currentMe?.balance||0).toLocaleString("ko-KR");
    $("#myHold").textContent    = (currentMe?.hold||0).toLocaleString("ko-KR");

    // 소지품 + 우승 감지
    const myItems=Array.isArray(currentMe?.items)? currentMe.items : [];
    const ulItems=$("#myItems"); ulItems.innerHTML="";
    myItems.forEach((it,i)=>{
      const li=document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.textContent=`${i+1}. ${it}`;
      ulItems.appendChild(li);
    });
    if(!d.gameOver){
      const reason=checkWin(myItems);
      if(reason){
        try{
          await updateDoc(ref,{ gameOver:true, winners:[myName], winReason:reason, updatedAt:serverTimestamp() });
          endUI("게임 종료!", [myName]);
        }catch(_){}
      }
    }

    // 현황
    const ul=$("#players"); ul.innerHTML="";
    currentPlayers.forEach((p,i)=>{
      const tag = d.phase==="choose" ? (p.readyPart?"응찰 확정":"대기") :
                  d.phase==="bid"    ? (p.readyBid ?"입찰 확정":"대기") : "대기";
      const stClass = /확정/.test(tag) ? "bg-emerald-100" : "bg-slate-100";
      const li=document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.innerHTML=`<div class="flex items-center gap-2">
        <span>${i+1}. ${p.name}</span>
        <span class="badge ${stClass}">${tag}</span>
      </div>`;
      ul.appendChild(li);
    });

    // 응찰자 공개
    if(Array.isArray(d.participants)){
      show("#revealBox", true);
      const pu=$("#participantList"); pu.innerHTML="";
      d.participants.forEach((nm,idx)=>{
        const li=document.createElement("li");
        li.className="border rounded px-3 py-2";
        li.textContent = `${idx+1}. ${nm}`;
        pu.appendChild(li);
      });
    }else{
      show("#revealBox", false);
    }

    // 단계별 UI
    if(d.phase==="choose"){
      show("#phaseChoose", true);
      show("#phaseBid", false);
      show("#mobileBidBar", false);

      // 응찰 라디오/버튼
      const partRadios=[...document.querySelectorAll('input[name="part"]')];
      const partVal = currentMe?.willParticipate===true ? "yes" :
                      currentMe?.willParticipate===false? "no"  : null;
      partRadios.forEach(r=>{ r.checked = (r.value===partVal); r.disabled = !!currentMe?.readyPart; });
      $("#btnLockPart").disabled = (!!currentMe?.readyPart) || !(d.currentItem);

      $("#partStatus").textContent = currentMe?.readyPart
        ? (currentMe?.willParticipate ? "응찰 참여 확정" : "불응찰 확정(+5만)") : "미확정";

      if(isHost){
        if (d.currentItem) $("#roundItem").value = d.currentItem;
        $("#bidStep").value = String(bidStep);
        const allLocked = currentPlayers.length>0 && currentPlayers.every(p=>p.readyPart===true);
        $("#btnReveal").disabled = !(allLocked && !!d.currentItem);
      }
    }
    else if(d.phase==="bid"){
      show("#phaseChoose", false);
      show("#phaseBid", true);

      const isParticipant = currentMe?.willParticipate===true;
      show("#bidBox", isParticipant);
      show("#bidDisabled", !isParticipant);
      show("#mobileBidBar", isParticipant);

      $("#bidStatus").textContent = currentMe?.readyBid ? "입찰 확정됨" : "대기중";

      const avail=(currentMe?.balance||0)+(currentMe?.hold||0);
      clampToAvail(avail);

      if(isHost){
        const participants = (d.participants||[]);
        const readyAll = participants.length>0 && currentPlayers
          .filter(p=>participants.includes(p.name))
          .every(p=>p.readyBid===true);
        $("#btnEndRound").disabled = !readyAll;
      }
    }

    bindStepButtons();
  });

  function showErr(msg){ const b=$("#errHost"); if(!b) return; b.textContent=msg; b.classList.remove("hidden"); }

  // 방장: 재료 선택/랜덤
  $("#roundItem").addEventListener("change", async ()=>{
    const val=$("#roundItem").value;
    try{ await updateDoc(ref,{ currentItem:val || "", updatedAt:serverTimestamp() }); }catch(_){}
  });
  $("#btnRandom").addEventListener("click", async ()=>{
    const r=randItem(); $("#roundItem").value=r;
    try{ await updateDoc(ref,{ currentItem:r, updatedAt:serverTimestamp() }); }catch(_){}
  });

  // 방장: 입찰 단위 설정
  $("#bidStep").addEventListener("change", async ()=>{
    const val=Number($("#bidStep").value||"10000")||10000;
    try{
      await updateDoc(ref,{ bidStep: val, updatedAt:serverTimestamp() });
      bidStep = val; setStepLabels();
    }catch(err){ showErr(`입찰 단위 설정 실패: ${err.message||err}`); }
  });

  // 방장: 라운드 시작(응찰 단계로) — 상태 초기화
  $("#btnStartRound").addEventListener("click", async ()=>{
    try{
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const r=snap.data(); const item=(r.currentItem||"").trim();
      if(!item){ alert("이번 상품을 먼저 선택하세요."); return; }
      let players=(r.players||[]).map(p=>({
        ...p, hold:0, bid:0, committed:false,
        readyPart:false, readyBid:false, willParticipate:null
      }));
      await updateDoc(ref,{
        players, participants: [],
        phase:"choose",
        updatedAt:serverTimestamp()
      });
      toast("라운드를 시작합니다. (응찰 선택)");
    }catch(err){ showErr(`라운드 시작 실패: ${err.message||err}`); }
  });

  // 방장: 1단계→2단계
  $("#btnReveal").addEventListener("click", async ()=>{
    try{
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const r=snap.data();
      const participants = (r.players||[]).filter(p=>p.willParticipate===true).map(p=>p.name);
      await updateDoc(ref, { phase:"bid", participants, updatedAt:serverTimestamp() });
    }catch(err){ showErr(`전환 실패: ${err.message||err}`); }
  });

  // 방장: 정산
  $("#btnEndRound").addEventListener("click", async ()=>{
    try{
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const r=snap.data(); const current=(r.currentItem||"").trim();
      if(!current){ alert("이번 상품이 설정되지 않았습니다."); return; }

      let players=(r.players||[]).map(p=>({...p}));

      const partNames=(r.participants||[]);
      const participants=players.filter(p=>partNames.includes(p.name));
      const maxHold = participants.length? Math.max(0, ...participants.map(p=>Number(p.hold||0))) : 0;
      const winners = participants.filter(p=>Number(p.hold||0)===maxHold && maxHold>0).map(p=>p.name);

      players = players.map(p=>{
        let balance=Number(p.balance||0), hold=Number(p.hold||0);
        const items=Array.isArray(p.items)? [...p.items] : [];
        const isParticipant = partNames.includes(p.name);
        if(isParticipant){
          if(hold>0 && !winners.includes(p.name)) balance += hold; // 환불
          if(winners.includes(p.name)) items.push(current);
        }
        return { ...p,
          balance, hold:0, bid:0, committed:false,
          readyPart:false, readyBid:false, willParticipate:null, items
        };
      });

      await updateDoc(ref, {
        players, round:Number(r.round||0)+1,
        lastItem: current, currentItem:"",
        participants: [], lastWinners: winners,
        resultRound: Number(r.round||0)+1,
        phase:"choose", updatedAt:serverTimestamp()
      });
      show("#mobileBidBar", false);
    }catch(err){ showErr(`정산 실패: ${err.message||err}`); }
  });

  // 게임 종료
  $("#btnEndGame").onclick = async ()=>{
    const ok=confirm("정말 게임을 종료하고 방을 삭제할까요?");
    if(!ok) return;
    try{ await deleteDoc(ref); }catch(err){ showErr(`삭제 실패: ${err.message||err}`); }
  };

  // 응찰 확정
  $("#btnLockPart").addEventListener("click", async ()=>{
    const cur=document.querySelector('input[name="part"]:checked');
    if(!cur){ alert("응찰/불응찰을 선택하세요."); return; }
    const choice = cur.value==="yes";
    try{
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const r=snap.data(); const players=(r.players||[]).map(p=>({...p}));
      const me=players.find(p=>p.name===myName); if(!me) return;
      if(me.readyPart){ toast("이미 응찰 확정했습니다."); return; }
      me.willParticipate = choice; me.readyPart = true;
      if(choice===false){ me.balance = Number(me.balance||0) + 50000; } // 불응찰 보너스
      await updateDoc(ref,{ players, updatedAt:serverTimestamp() });
      toast(choice ? "응찰 참여를 확정했습니다." : "불응찰(+50,000원)을 확정했습니다.");
    }catch(err){ alert(`응찰 확정 실패: ${err.message||err}`); }
  });

  // 입찰 확정/취소(공통)
  async function doConfirmBid(){
    const snap=await getDoc(ref); if(!snap.exists()) return;
    const r=snap.data(); if(r.phase!=="bid"){ toast("아직 입찰 단계가 아닙니다."); return; }
    const players=(r.players||[]).map(p=>({...p}));
    const me=players.find(p=>p.name===myName); if(!me) return;
    if(me.willParticipate!==true){ toast("이번 라운드는 입찰할 수 없습니다."); return; }

    const avail=Number(me.balance||0)+Number(me.hold||0);
    let val = snapToStep(stagedBid);
    val = Math.max(0, Math.min(val, avail));
    me.hold=val; me.bid=val; me.balance=avail - val; me.committed=true; me.readyBid=true;
    await updateDoc(ref,{ players, updatedAt:serverTimestamp() });
    toast("입찰을 확정했습니다.");
  }
  async function doCancelBid(){
    const snap=await getDoc(ref); if(!snap.exists()) return;
    const r=snap.data(); if(r.phase!=="bid"){ toast("아직 입찰 단계가 아닙니다."); return; }
    const players=(r.players||[]).map(p=>({...p}));
    const me=players.find(p=>p.name===myName); if(!me) return;
    if(me.willParticipate!==true){ toast("이번 라운드는 입찰할 수 없습니다."); return; }
    const refund=Number(me.hold||0);
    me.balance=Number(me.balance||0)+refund; me.hold=0; me.bid=0; me.committed=false; me.readyBid=true;
    await updateDoc(ref,{ players, updatedAt:serverTimestamp() });
    toast("입찰을 취소했습니다.");
  }

  $("#btnConfirmBid")?.addEventListener("click", doConfirmBid);
  $("#btnCancelBid")?.addEventListener("click", doCancelBid);
  $("#btnConfirmBidMobile")?.addEventListener("click", doConfirmBid);
  $("#btnCancelBidMobile")?.addEventListener("click", doCancelBid);

  // 입력 이벤트
  $("#bidInput")?.addEventListener("input", ()=>{ stagedBid = parseMoney($("#bidInput").value); syncBidInputs(); });
  $("#bidInput")?.addEventListener("blur",  ()=>{ const a=(currentMe?.balance||0)+(currentMe?.hold||0); clampToAvail(a); });
  $("#bidInputMobile")?.addEventListener("input", ()=>{ stagedBid = parseMoney($("#bidInputMobile").value); syncBidInputs(); });
  $("#bidInputMobile")?.addEventListener("blur",  ()=>{ const a=(currentMe?.balance||0)+(currentMe?.hold||0); clampToAvail(a); });

  // 라운드 결과 토스트
  onSnapshot(ref,(s)=>{
    if(!s.exists()) return;
    const d=s.data();
    if((d.resultRound||0) <= lastSeenResultRound) return;
    lastSeenResultRound = d.resultRound||0;

    const winners = Array.isArray(d.lastWinners)? d.lastWinners : [];
    const wasPart = Array.isArray(d.participantsBackup) ? d.participantsBackup.includes(myName)
                    : Array.isArray(d.participants) ? d.participants.includes(myName) : null;

    if (winners.includes(myName)) toast(`낙찰되었습니다! (${d.lastItem})`);
    else if (wasPart===true)      toast(`낙찰 실패(환불 완료).`);
    else                          toast(`불응찰 라운드 종료.`);
  });
</script>
</body>
</html>
