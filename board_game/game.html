<!-- ...중략 (head/스타일/Firebase 로딩 동일) ... -->
<script type="module">
  const $=s=>document.querySelector(s);
  const fmt=n=>Number(n||0).toLocaleString("ko-KR");
  const show=(id,yes)=>$(id).classList.toggle("hidden",!yes);
  const toast=(msg)=>{ $("#toastMsg").textContent=msg; $("#toast").classList.remove("hidden"); setTimeout(()=>$("#toast").classList.add("hidden"), 2000); };

  const params=new URL(location.href).searchParams;
  const roomId=(params.get("room")||"").toUpperCase();
  const myName=(params.get("name")||"").trim();

  await window.firebaseReady;
  const { getFirestore, doc, getDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp, getAuth, signInAnonymously } = window.__fb;
  const db=getFirestore(), auth=getAuth();
  if(!auth.currentUser) await signInAnonymously(auth);

  const ref=doc(db,"rooms",roomId);

  let isHost=false, currentPlayers=[], currentMe=null, stagedBid=0, lastSeenResultRound=0;

  async function init() {
    const s=await getDoc(ref);
    if(!s.exists()){ endUI("방이 삭제되었습니다."); return; }
    const r=s.data();
    isHost=(r.hostName===myName);
    show("#hostPanel", isHost);
    lastSeenResultRound = r.resultRound || 0;

    // ❌ (삭제됨) 호스트 beforeunload 자동 삭제
    // window.addEventListener("beforeunload", async ()=>{ try{ await deleteDoc(ref); }catch(_){ } });
  }
  await init();

  // ... 이하 onSnapshot/입찰/라운드 종료/종료 버튼 로직은 기존 본문과 동일 ...
  // 종료 버튼만 문서 삭제 실행
  $("#btnEndGame").onclick = async ()=>{
    if(!isHost) return;
    const ok = confirm("정말 게임을 종료하고 방을 삭제할까요?");
    if(!ok) return;
    try{ await deleteDoc(ref); }catch(err){ /* 에러 표시 */ }
  };
</script>
