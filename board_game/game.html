<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 게임(game)</title>
<script src="https://cdn.tailwindcss.com"></script>


<script type="module" id="fb-sdk">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };
  const ready=(async()=>{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>


<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .badge{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem}
  .card{background:#fff;border-radius:1rem;box-shadow:0 1px 3px rgb(0 0 0 / .06),0 1px 2px rgb(0 0 0 / .04)}
  .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom,0) + 80px);}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;border:1px solid rgb(226 232 240);background:#f8fafc;padding:.5rem}
  .icon-btn svg{width:16px;height:16px}
</style>
</head>
<body class="bg-slate-50 text-slate-900 safe-bottom">
<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">


  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 게임</span></h1>
      <div class="text-sm text-slate-600 mt-1">
        Room <span id="roomId" class="mono">—</span> · Round <span id="round" class="mono">0</span>
        · You: <span id="you" class="font-medium"></span>
        · Role: <span id="role" class="font-medium">guest</span>
        · Mode: <span id="mode" class="font-medium">—</span>
      </div>
    </div>
    <span id="badge" class="badge bg-slate-200">연결 준비중…</span>
  </header>


  <div id="endedBox" class="hidden p-4 rounded border bg-emerald-50 border-emerald-200 text-emerald-800 text-sm">
    <span id="endMsg">게임이 종료되었습니다.</span>
    <a id="btnReplay" href="room.html" class="ml-3 underline">다시하기(방 목록/생성으로)</a>
  </div>


  <div id="grid" class="grid gap-4 lg:grid-cols-12">


    <section id="panelMe" class="card p-4 md:p-6 lg:col-span-5 xl:col-span-4">
      <h2 class="font-semibold mb-3">내 정보</h2>
      <div class="text-sm">닉네임: <span id="myName" class="font-medium"></span></div>
      <div class="text-sm mt-1">소지금: <span id="myBalance" class="mono font-bold">0</span>원</div>
      <div class="text-sm mt-1">보류금(확정된 입찰): <span id="myHold" class="mono font-bold">0</span>원</div>


      <hr class="my-4">


      <div id="phaseChoose" class="space-y-3">
        <h3 class="font-semibold">1) 응찰 여부 선택</h3>
        <div class="text-sm">이번 상품: <b id="currentItemMe">-</b></div>
  
        <div class="mt-2">
          <img id="imgCurrentMe" alt="이번 상품 이미지" width="60" height="60" class="rounded object-contain border" style="display:none;">
        </div>


        <div class="flex items-center gap-4 mt-2">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="part" value="yes" /> 응찰 참여
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="part" value="no" /> 불응찰(+50,000원)
          </label>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnLockPart" class="btn bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">응찰 확정</button>
          <button id="btnResyncPart" class="icon-btn" aria-label="새로고침" title="새로고침">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v6h-6"/></svg>
          </button>
          <span id="partStatus" class="badge bg-slate-100">미확정</span>
        </div>
        <p class="text-xs text-slate-500">※ 불응찰 확정 시 이번 라운드 입찰은 불가하며 즉시 50,000원이 지급됩니다.</p>
        <p id="chooseHint" class="text-xs text-slate-500 hidden">※ 보드게임 모드: 방장이 상품을 선택해야 응찰 확정이 가능해요.</p>
      </div>


      <div id="phaseBid" class="hidden space-y-3">
        <h3 class="font-semibold">2) 비공개 입찰</h3>
        <div class="text-sm">이번 상품: <b id="currentItemBid">-</b></div>
        <div class="mt-2">
          <img id="imgCurrentBid" alt="이번 상품 이미지" width="60" height="60" class="rounded object-contain border" style="display:none;">
        </div>


        <div id="bidDisabled" class="hidden text-sm text-slate-500">이번 라운드 불응찰을 선택하여 입찰할 수 없습니다.</div>


        <div id="bidBox" class="hidden">
          <div class="flex items-center gap-2 mb-2 flex-wrap">
            <button data-step="-5" class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm">-5단위</button>
            <button data-step="-1" class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm">-1단위</button>
            <input id="bidInput" inputmode="numeric" class="mono w-36 md:w-44 border rounded px-3 py-2 text-right" placeholder="0" aria-label="입찰 금액(원)" />
            <button data-step="1"  class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm">+1단위</button>
            <button data-step="5"  class="shrink-0 w-16 px-2 py-2 rounded bg-slate-200 text-xs md:text-sm">+5단위</button>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnConfirmBid"  class="btn bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">입찰 확정</button>
            <button id="btnCancelBid"   class="btn bg-slate-300 hover:bg-slate-400 rounded px-4 py-2">입찰 취소</button>
            <span id="bidStatus" class="badge bg-slate-100">대기중</span>
          </div>
          <p class="text-xs text-slate-500">※ 당신의 입찰액은 공개되지 않습니다.</p>
        </div>
      </div>


      <hr class="my-4">


      <h3 class="font-semibold mb-2">내 소지품</h3>
      <ul id="myItems" class="mt-2 space-y-2 text-sm"></ul>


      <div class="mt-4 p-3 rounded border bg-slate-50 text-sm">
        <div class="font-semibold mb-1">승리 조건</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>모두 같은 재료 <b>3개</b></li>
          <li>모두 다른 재료 <b>4개</b></li>
          <li>재료 <b>5개</b></li>
        </ul>
      </div>
    </section>


    <section id="panelPublic" class="card p-4 md:p-6 lg:col-span-7 xl:col-span-5">
      <h2 class="font-semibold mb-3">라운드 정보</h2>
      <div class="text-sm text-slate-600 mb-2">
        라운드 단계: <b id="phaseText">-</b> · 이번 상품: <b id="currentItem">-</b>
      </div>
      <div class="mt-2">
        <img id="imgCurrentPublic" alt="이번 상품 이미지" width="60" height="60" class="rounded object-contain border" style="display:none;">
      </div>


      <div id="revealBox" class="hidden mt-4">
        <h3 class="font-semibold mb-2">이번 라운드 응찰자</h3>
        <ul id="participantList" class="space-y-2 text-sm"></ul>
        <p class="text-xs text-slate-500 mt-2">※ 응찰자 명단만 공개됩니다. 낙찰자/입찰액은 공개되지 않습니다.</p>
      </div>


      <h3 class="font-semibold mt-6 mb-2">라운드 로그</h3>
      <ul id="roundLog" class="space-y-2 text-xs text-slate-700"></ul>


      <div id="detailLogWrap" class="hidden">
        <h3 class="font-semibold mt-6 mb-2">게임 기록(상세)</h3>
        <div class="flex items-center gap-2 mb-2">
          <button id="btnExportJSON" class="btn bg-slate-800 text-white rounded px-3 py-1.5 text-xs">JSON 내보내기</button>
          <button id="btnExportCSV"  class="btn bg-slate-200 rounded px-3 py-1.5 text-xs">CSV 내보내기</button>
        </div>
        <ul id="detailLog" class="space-y-2 text-xs text-slate-700"></ul>
        <p class="text-xs text-slate-500 mt-2">※ 전체 상세 로그와 내보내기는 게임 종료 후에만 확인할 수 있어요.</p>
      </div>


      <h3 class="font-semibold mt-6 mb-2">플레이어 현황</h3>
      <ul id="players" class="space-y-2 text-sm"></ul>
      <div class="text-xs text-slate-500 mt-2">※ 잔액은 각자만 확인합니다.</div>
    </section>


    <section id="hostPanel" class="hidden card p-4 md:p-6 lg:col-span-3 xl:col-span-3">
      <h2 class="font-semibold mb-3">방장 설정</h2>
      <div id="modeNotice" class="text-xs text-slate-600 mb-2"></div>


      <label class="text-sm block mb-1">이번 상품</label>
      <div class="flex items-center gap-2 mb-3">
        <select id="roundItem" class="w-full border rounded px-3 py-2">
          <option value="">— 선택 —</option>
          <option>오징어</option><option>독도새우</option><option>호박</option><option>명이나물</option>
        </select>
        <button id="btnRandom" class="btn bg-slate-200 rounded px-3 py-2">랜덤</button>
      </div>
      <p class="text-xs text-slate-500 mb-3">카드를 뒤집어 다음에 경매에 등장할 상품을 등록하세요.</p>


      <hr class="my-4">
      <button id="btnEndGame" class="btn w-full bg-rose-600 hover:bg-rose-700 text-white rounded px-4 py-2">
        게임 종료(보존)
      </button>
      <div id="errHost" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
    </section>
  </div>


  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-black/80 text-white px-3 py-2 rounded z-40 flex items-center gap-2">
    <img id="toastImg" width="20" height="20" style="display:none" alt="">
    <span id="toastMsg"></span>
  </div>
</div>


<div id="mobileBidBar" class="md:hidden fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t shadow-lg z-50 hidden">
  <div class="max-w-7xl mx-auto px-3 py-2">
    <div class="text-xs text-slate-600 mb-1">이번 상품: <b id="currentItemMobile">-</b></div>
    <div class="mt-1"><img id="imgCurrentMobile" alt="이번 상품 이미지" width="60" height="60" class="rounded object-contain border" style="display:none;"></div>
    <div class="flex items-center gap-2 mt-2">
      <button data-step="-5" class="flex-1 min-w-[56px] py-2 rounded bg-slate-200 text-xs">-5단위</button>
      <button data-step="-1" class="flex-1 min-w-[56px] py-2 rounded bg-slate-200 text-xs">-1단위</button>
      <input id="bidInputMobile" inputmode="numeric" class="mono w-28 flex-none border rounded px-2 py-2 text-right" placeholder="0" />
      <button data-step="1"  class="flex-1 min-w-[56px] py-2 rounded bg-slate-200 text-xs">+1단위</button>
      <button data-step="5"  class="flex-1 min-w-[56px] py-2 rounded bg-slate-200 text-xs">+5단위</button>
    </div>
    <div class="flex items-center gap-2 mt-2">
      <button id="btnConfirmBidMobile" class="flex-1 py-2 rounded bg-indigo-600 text-white">확정</button>
      <button id="btnCancelBidMobile"  class="flex-1 py-2 rounded bg-slate-300">취소</button>
    </div>
  </div>
</div>


<script type="module">
  const $=s=>document.querySelector(s);
  const fmt=n=>Number(n||0).toLocaleString("ko-KR");
  const show=(sel,yes)=>$(sel).classList.toggle("hidden",!yes);
  const toast=(msg,img)=>{ $("#toastMsg").textContent=msg; const im=$("#toastImg"); if(img){im.src=img; im.style.display="";}else{im.style.display="none";} $("#toast").classList.remove("hidden"); setTimeout(()=>$("#toast").classList.add("hidden"), 2200); };


  const params=new URL(location.href).searchParams;
  const roomId=(params.get("room")||"").toUpperCase();
  const myName=(params.get("name")||"").trim();
  $("#roomId").textContent=roomId||"—"; $("#you").textContent=myName||"—";
  $("#myName").textContent=myName||"—";


  await window.firebaseReady;
  const { getFirestore, doc, getDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp,
          getAuth, signInAnonymously, runTransaction } = window.__fb;
  const db=getFirestore(), auth=getAuth();
  try{ if(!auth.currentUser) await signInAnonymously(auth);
       $("#badge").textContent="연결됨"; $("#badge").className="badge bg-indigo-600 text-white";
  }catch(e){ $("#badge").textContent="연결 실패"; $("#badge").className="badge bg-rose-600 text-white"; }


  const ref=doc(db,"rooms",roomId);


  /* ───────── 비활성 자동 삭제(1시간) ───────── */
  const STALE_MS = 60 * 60 * 1000;
  const isStale = (d)=>{ try{ const ts=d?.updatedAt?.toMillis?.(); return ts ? (Date.now()-ts>STALE_MS) : false; }catch{return false;} };
  // 이미지 매핑
  const ITEM_IMG = {"오징어":"squid.png","독도새우":"shrimp.png","호박":"pumpkin.png","명이나물":"wild_leek.png"};
  const RESULT_IMG = { success:"success.png", fail:"fail.png" };
  function setItemImg(el, item){ if(!el) return;
    const file=ITEM_IMG[item||""]; if(file){ el.src=file; el.style.display=""; el.alt=item||"상품"; }else{ el.style.display="none"; } }
  function renderItemImages(item){ setItemImg($("#imgCurrentMe"),item); setItemImg($("#imgCurrentBid"),item); setItemImg($("#imgCurrentPublic"),item); setItemImg($("#imgCurrentMobile"),item);
  }


  // 유틸/상태
  function guessHost(r){const a=(r?.hostName||"").trim().toLowerCase(); const b=(myName||"").trim().toLowerCase(); const p1=(r?.players||[])[0]; const p1n=(p1?.name||"").trim().toLowerCase(); return (a&&a===b)||(p1n&&p1n===b);}
  function checkWin(items=[]){const t=items.length,c={};items.forEach(it=>c[it]=(c[it]||0)+1);
    if(t>=5) return "any5"; if(Object.values(c).some(v=>v>=3)) return "same3"; if(new Set(items).size>=4) return "diff4"; return "";}
  const ITEMS=["오징어","독도새우","호박","명이나물"]; const randItem=()=>ITEMS[Math.floor(Math.random()*ITEMS.length)];
  let isHost=false, currentPlayers=[], currentMe=null;
  let lastSeenResultRound=0, singleRevealTimerSet=false;
  let boardMode=false; // room.boardMode 반영


  // 입찰(1만 단위)
  let bidStep=10000, stagedBid=0;
  const parseMoney=s=>Number((s||"0").replace(/[^\d]/g,""))||0;
  const snapToStep=n=>Math.floor(Number(n||0)/bidStep)*bidStep;
  const bidInput=$("#bidInput"), bidInputMobile=$("#bidInputMobile");
  function syncBidInputs(){const v=snapToStep(stagedBid); if(bidInput) bidInput.value=v.toLocaleString("ko-KR"); if(bidInputMobile) bidInputMobile.value=v.toLocaleString("ko-KR");}
  function clampToAvail(a){ stagedBid=Math.max(0, Math.min(snapToStep(stagedBid), a));
    syncBidInputs(); }
  function bindStepButtons(){ document.querySelectorAll("[data-step]").forEach(btn=>{ if(btn._bound) return; btn._bound=true; btn.addEventListener("click", ()=>{ const factor=Number(btn.getAttribute("data-step")); const delta=factor*bidStep; const avail=(currentMe?.balance||0)+(currentMe?.hold||0); stagedBid=stagedBid+delta; clampToAvail(avail); }); });
  }
  syncBidInputs(); bindStepButtons();
  bidInput?.addEventListener("input", ()=>{ stagedBid=parseMoney(bidInput.value); syncBidInputs(); });
  bidInput?.addEventListener("blur",  ()=>{ clampToAvail((currentMe?.balance||0)+(currentMe?.hold||0)); });
  bidInputMobile?.addEventListener("input", ()=>{ stagedBid=parseMoney(bidInputMobile.value); syncBidInputs(); });
  bidInputMobile?.addEventListener("blur",  ()=>{ clampToAvail((currentMe?.balance||0)+(currentMe?.hold||0)); });


  // UI용 유틸
  function endUI(msg){
    $("#endMsg").textContent = msg || "게임이 종료되었습니다.";
    $("#endedBox").classList.remove("hidden");
    show("#panelMe", false); show("#panelPublic", false); show("#hostPanel", false);
    show("#mobileBidBar", false);
  }
  function updatePlayerList(players, me, r){
    const ul=$("#players"); if(!ul) return;
    ul.innerHTML="";
    players.sort((a,b)=>a.joinAt-b.joinAt).forEach(p=>{
      const li=document.createElement("li");
      const isMe=p.name===me?.name;
      const c = p.committed===true || p.readyBid===true; // bid 단계에서 확정
      const pC = p.readyPart===true; // choose 단계에서 확정
      const status = r.phase==="bid" ? (c?"<span class='badge bg-indigo-100 text-indigo-700'>입찰완료</span>":"")
                   : r.phase==="choose" ? (pC?"<span class='badge bg-indigo-100 text-indigo-700'>선택완료</span>":"")
                   : "";
      li.innerHTML=`
        <div class="flex items-center justify-between">
          <span>${isMe?"<b>(나)</b>":""} ${p.name||"?"}</span>
          ${status}
        </div>
        <div class="text-xs text-slate-500 ml-2">
          ${(p.items||[]).join(" ")}
        </div>
      `;
      ul.appendChild(li);
    });
  }


  /* ───────── 핵심 로직: 상태 전이 ───────── */


  // (A) 초기화/Choose (모두 응찰/불응찰 확정시) → B 또는 C로
  async function attemptSettleFromChoose(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="choose") return;
        const players=(r.players||[]).map(p=>({...p}));
        const readyAll = players.length===0 ? true : players.every(p=>p.readyPart===true || p.ready===true); // ready: 구버전 호환
        if(!readyAll) return;


        // 1. 불응찰자(5만) 정산
        const skipped=[];
        players.forEach(p=>{
          if(p.willParticipate===false && p.readyPart===true && p.hold!==50000){ // 5만 지급
            p.balance = (p.balance||0) + 50000;
            p.hold = 50000; // 중복 지급 방지 플래그
            skipped.push(p.name);
          }
        });


        // 2. 응찰자 선별
        const parts=players.filter(p=>p.willParticipate===true).map(p=>p.name);


        // 3. 상품 결정 (중요)
        const item=r.currentItem; // 이미 선택된 값(보드/웹 공통)
        const chosenItem = item || randItem(); // 웹모드 백업


        // 4. 분기
        if(parts.length===0){
          // (전원 불응찰) → 즉시 Choose
          const reset=players.map(p=>({...p,hold:0,bid:0,committed:false,readyPart:false,readyBid:false,willParticipate:null}));
          const logs=[...(r.roundLogs||[])];
          logs.push({round:(r.round||0)+1, item:chosenItem, participants:[], winners:[]});
          tx.update(ref,{
            players:reset, round:(r.round||0)+1,
            currentItem:"", participants:[], participantsBackup:[],
            lastItem:"", lastWinners:[], resultRound:(r.round||0)+1,
            phase:"choose", roundLogs:logs.slice(-30),
            updatedAt:serverTimestamp()
          });
          return;
        }
        if(parts.length===1){
          // (단독 응찰) → C (Reveal Single)
          tx.update(ref,{
            participants:parts, participantsBackup:parts,
            currentItem:chosenItem, lastItem:chosenItem,
            phase:"reveal_single",
            revealRound:(r.round||0)+1, revealAt:serverTimestamp(),
            updatedAt:serverTimestamp()
          });
          return;
        }


        // (경쟁 응찰) → B (Bid)
        tx.update(ref,{
          participants:parts, participantsBackup:parts,
          currentItem:chosenItem, lastItem:chosenItem,
          phase:"bid",
          updatedAt:serverTimestamp()
        });
      });
    }catch(e){ console.warn(e); }
  }


  // (B) bid → 정산 (모두 0원인 경우 전원 지급) + 상세 로그
  async function attemptSettleFromBid(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="bid") return;


        let players=(r.players||[]).map(p=>({...p}));
        const partNames=(r.participants||[]);
        const participants=players.filter(p=>partNames.includes(p.name));
        
        const readyAll = participants.length===0 ? true : participants.every(p=>p.readyBid===true || p.committed===true);
        if(!readyAll) return;


        // ########## ☢️ 버그 수정 ☢️ ##########
        // const item=(r.currentItem||"").trim() || randItem(); // [BEFORE]
        const item=(r.currentItem||"").trim(); // [AFTER 1]
        
        // [AFTER 2] 아이템이 비어있으면(동기화 문제 등), 정산 로직을 실행하지 않고 중단
        if(!item){
          console.warn("attemptSettleFromBid: currentItem is empty. Aborting transaction.");
          return; 
        }
        // ######################################


        const bids = {};
        participants.forEach(p=>{ bids[p.name] = p.bid || 0; });


        // 1. 낙찰자 선정
        let winners=[], winningBid=0;
        const bidsInvolved=participants.map(p=>p.bid||0);
        const maxBid=Math.max(0, ...bidsInvolved);
        const allZero=maxBid===0 && bidsInvolved.every(b=>b===0);


        if(allZero){ // (전원 0원) → 전원 낙찰
          winners=participants.map(p=>p.name);
          winningBid=0;
        }else{ // (최고가 낙찰)
          winners=participants.filter(p=>(p.bid||0)===maxBid).map(p=>p.name);
          winningBid=maxBid;
        }


        // 2. 정산 및 아이템 지급
        let victory=false, victoryReason="", finalWinners=[];
        players.forEach(p=>{
          if(winners.includes(p.name)){
            p.balance = (p.balance||0) - winningBid; // 입찰액 차감
            p.items = [...(p.items||[]), item]; // 아이템 지급
          }
          // 리셋
          p.hold=0; p.bid=0; p.committed=false; p.readyPart=false; p.readyBid=false; p.willParticipate=null;


          // 3. 승리 확인
          if(!victory){
            const reason=checkWin(p.items);
            if(reason){
              victory=true; victoryReason=reason; finalWinners=winners; // TODO: 동시 승리?
            }
          }
        });


        // 4. 로그 기록
        const logs=[...(r.roundLogs||[])];
        logs.push({round:r.round, item, participants:partNames, winners});
        const detailed=[...(r.roundLogsDetailed||[])];
        detailed.push({
          round:r.round, item, mode:"bid",
          winningBid, winners,
          participants:partNames,
          bids:bids,
          skipped: (r.players||[]).filter(p=>!partNames.includes(p.name)).map(p=>p.name),
          ts: Date.now()
        });


        if(victory){
          tx.update(ref,{
            players:players,
            phase:"game_over", gameOver:true, endedAt:serverTimestamp(),
            finalWinners:finalWinners, victoryReason:victoryReason,
            roundLogs:logs.slice(-30), roundLogsDetailed: detailed,
            updatedAt:serverTimestamp()
          });
          return;
        }


        // 5. 다음 라운드(Choose)로
        tx.update(ref,{
          players:players,
          round: (r.round||0)+1,
          currentItem:"", // 상품 비우기
          participants:[], participantsBackup:[],
          lastItem:item, lastWinners:winners, resultRound:r.round, // 결과 표시용
          phase:"choose",
          roundLogs:logs.slice(-30), roundLogsDetailed: detailed,
          updatedAt:serverTimestamp()
        });
      });
    }catch(e){ console.warn(e); }
  }


  // (C) 단독 응찰자 정산 (즉시)
  async function settleSingleWinner(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="reveal_single") return;


        let players=(r.players||[]).map(p=>({...p}));
        const partNames=(r.participants||[]); // 1명
        const item=(r.currentItem||"").trim();
        const winnerName = partNames[0] || null;


        // 1. 정산 및 아이템 지급
        let victory=false, victoryReason="", finalWinners=[];
        players.forEach(p=>{
          if(p.name===winnerName){
            // p.balance = (p.balance||0) - 0; // 0원
            p.items = [...(p.items||[]), item]; // 아이템 지급
          }
          // 리셋
          p.hold=0; p.bid=0; p.committed=false; p.readyPart=false; p.readyBid=false; p.willParticipate=null;


          // 2. 승리 확인
          if(!victory){
            const reason=checkWin(p.items);
            if(reason){
              victory=true; victoryReason=reason; finalWinners=[winnerName];
            }
          }
        });


        // 3. 로그 기록
        const logs=[...(r.roundLogs||[])];
        logs.push({round:r.round, item, participants:partNames, winners:partNames});
        const detailed=[...(r.roundLogsDetailed||[])];
        detailed.push({
          round:r.round, item, mode:"single",
          winningBid:0, winners:partNames,
          participants:partNames,
          bids:{[winnerName]:0},
          skipped: (r.players||[]).filter(p=>!partNames.includes(p.name)).map(p=>p.name),
          ts: Date.now()
        });


        if(victory){
          tx.update(ref,{
            players:players,
            phase:"game_over", gameOver:true, endedAt:serverTimestamp(),
            finalWinners:finalWinners, victoryReason:victoryReason,
            roundLogs:logs.slice(-30), roundLogsDetailed: detailed,
            updatedAt:serverTimestamp()
          });
          return;
        }


        // 4. 다음 라운드(Choose)로
        tx.update(ref,{
          players:players,
          round: (r.round||0)+1,
          currentItem:"", // 상품 비우기
          participants:[], participantsBackup:[],
          lastItem:item, lastWinners:partNames, resultRound:r.round, // 결과 표시용
          phase:"choose",
          roundLogs:logs.slice(-30), roundLogsDetailed: detailed,
          updatedAt:serverTimestamp()
        });
      });
    }catch(e){ console.warn(e); }
  }


  // (D) (호스트) 상품 선택 (웹 모드면 자동 선택)
  async function ensurePhaseDefault(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        // 1. Choose 단계고, 2. 상품이 비었고, 3. 웹모드(boardMode:false)
        if(r.phase==="choose" && !r.currentItem && r.boardMode!==true){
          tx.update(ref, { currentItem: randItem(), updatedAt: serverTimestamp() });
        }
      });
    }catch(e){ console.warn(e); }
  }
  // (D-Host) 방장 수동 선택
  $("#roundItem")?.addEventListener("change", async (e)=>{
    const item=e.target.value; if(!item) return;
    try{ await updateDoc(ref, { currentItem: item, updatedAt: serverTimestamp() });
         toast("상품 등록됨");
    }catch(e){ toast(`실패: ${e.message}`); }
  });
  $("#btnRandom")?.addEventListener("click", ()=>{
    const item=randItem(); $("#roundItem").value=item;
    $("#roundItem").dispatchEvent(new Event("change"));
  });


  // (E) (호스트) 게임 강제 종료
  $("#btnEndGame")?.addEventListener("click", async ()=>{
    if(!confirm("정말 게임을 종료(보존)합니까?")) return;
    try{
      await updateDoc(ref, {
        phase:"game_over", gameOver:true, endedAt:serverTimestamp(),
        finalWinners:[], victoryReason:"host_terminated",
        updatedAt:serverTimestamp()
      });
    }catch(e){
      $("#errHost").textContent = `종료 실패: ${e.message||e}`;
      show("#errHost", true);
    }
  });


  /* ───────── 스냅샷 (UI 렌더링) ───────── */


  // 초기
  await ensurePhaseDefault();


  // 스냅샷
  onSnapshot(ref, async (s)=>{
    if(!s.exists()){
      endUI("방이 종료(삭제)되었습니다.");
      return;
    }
    const d=s.data();
    window.__lastRoomSnap = d; // 내보내기용 캐시


    // 오래된 방 자동 삭제
    if(!d.gameOver && isStale(d)){
      try{ await deleteDoc(ref); return; }catch(_){}
    }


    boardMode = d.boardMode===true;
    $("#mode").textContent = boardMode ? "보드게임" : "웹 전용";


    $("#round").textContent=d.round??0;
    const phaseLabel = d.phase==="choose" ? "응찰 선택" :
                       d.phase==="bid" ? "비공개 입찰" :
                       d.phase==="reveal_single" ? "단독 응찰 공개" : "-";
    $("#phaseText").textContent = phaseLabel;
    $("#currentItem").textContent = d.currentItem || "-";
    $("#currentItemMe").textContent = d.currentItem || "-";
    $("#currentItemBid").textContent= d.currentItem || "-";
    $("#currentItemMobile").textContent = d.currentItem || "-";
    renderItemImages(d.currentItem || "");


    isHost=guessHost(d);
    $("#role").textContent=isHost?"host":"guest";
    show("#hostPanel", isHost);
    $("#modeNotice").textContent = boardMode ? "현재 보드게임 모드입니다. 방장이 상품을 수동으로 선택해야 라운드가 진행됩니다." : "현재 웹 전용 모드입니다. 상품은 자동으로 결정됩니다.";


    const players = Array.isArray(d.players)? d.players : [];
    const me = players.find(p=>p.name===myName) || null;
    currentPlayers = players; currentMe = me;
    window.currentPlayers = players; window.currentMe = me; // 디버깅용


    $("#myBalance").textContent = fmt(me?.balance||0);
    $("#myHold").textContent = fmt(me?.hold||0);
    const myItemsUl=$("#myItems"); myItemsUl.innerHTML="";
    (me?.items||[]).forEach(it=>{
      const li=document.createElement("li");
      const img=ITEM_IMG[it];
      li.innerHTML = img ? `<img src="${img}" alt="${it}" width="32" height="32" class="inline-block" title="${it}"> ${it}` : it;
      myItemsUl.appendChild(li);
    });


    // 플레이어 목록
    updatePlayerList(players, me, d);


    // 라운드 로그
    const logUl = $("#roundLog");
    logUl.innerHTML = "";
    (d.roundLogs||[]).slice().reverse().forEach(entry=>{
      const li=document.createElement("li");
      li.textContent=`R${entry.round} · ${entry.item||"-"} · 낙찰: ${(entry.winners||[]).join(", ")||"없음"}`;
      logUl.appendChild(li);
    });


    // 상세 로그(종료 시에만 표시)
    show("#detailLogWrap", !!d.gameOver);
    if(d.gameOver){
      const detUl = $("#detailLog");
      detUl.innerHTML="";
      const dlogs = d.roundLogsDetailed || [];
      dlogs.slice().reverse().forEach(entry=>{
        const li=document.createElement("li");
        const bidsTxt = Object.keys(entry.bids||{}).length ? Object.entries(entry.bids).map(([nm,amt])=>`${nm}:${fmt(amt)}원`).join(", ") : "—";
        const skips = (entry.skipped||[]).length ? entry.skipped.join(", ") : "없음";
        li.className="border rounded px-3 py-2 bg-white";
        li.innerHTML = `
          <div class="flex items-center justify-between">
            <div>R${entry.round} · <b>${entry.item||"-"}</b> <span class="text-[10px] text-slate-400">(${entry.mode})</span></div>
            <div class="text-slate-500">낙찰가: ${fmt(entry.winningBid||0)}원</div>
          </div>
          <div class="mt-1 text-slate-700">응찰액: ${bidsTxt}</div>
          <div class="mt-1 text-slate-700">낙찰: ${(entry.winners||[]).join(", ") || "—"}</div>
          <div class="mt-1 text-slate-500">불응찰: ${skips}</div>
        `;
        detUl.appendChild(li);
      });
      const winners = (d.finalWinners||[]).join(", ") || "—";
      $("#endMsg").textContent = `게임 종료! 우승: ${winners}`;
      $("#endedBox").classList.remove("hidden");
    }


    // 단계별 UI + 자동 전환
    if(d.phase==="choose" || d.phase===undefined){
      show("#phaseChoose", true); show("#phaseBid", false); show("#revealBox", false); show("#mobileBidBar", false);
      const canEdit = !(me?.readyPart || me?.ready);
      [...document.querySelectorAll('input[name="part"]')].forEach(r=> r.disabled = !canEdit);
      $("#btnLockPart").disabled = !canEdit || !(d.currentItem);
      $("#partStatus").textContent = (me?.readyPart||me?.ready) ? (me?.willParticipate ? "응찰 참여 확정" : "불응찰 확정(+5만)") : "미확정";
      if(me?.willParticipate===true) $('input[name="part"][value="yes"]').checked=true;
      if(me?.willParticipate===false)$('input[name="part"][value="no"]').checked=true;
      show("#chooseHint", boardMode && !d.currentItem);
      // (전환)
      await ensurePhaseDefault(); // 웹모드 상품 자동 선택
      await attemptSettleFromChoose(); // 모두 응찰/불응찰 시
    }


    if(d.phase==="bid"){
      show("#phaseChoose", false); show("#phaseBid", true); show("#revealBox", false);
      const canBid = me?.willParticipate===true && !(me?.readyBid||me?.committed);
      show("#bidBox", me?.willParticipate===true);
      show("#bidDisabled", me?.willParticipate!==true);
      show("#mobileBidBar", me?.willParticipate===true);
      $("#bidInput").disabled = !canBid;
      $("#bidInputMobile").disabled = !canBid;
      $("#btnConfirmBid").disabled = !canBid; $("#btnConfirmBidMobile").disabled = !canBid;
      $("#btnCancelBid").disabled = !(me?.readyBid||me?.committed); $("#btnCancelBidMobile").disabled = !(me?.readyBid||me?.committed);
      $("#bidStatus").textContent = (me?.readyBid||me?.committed) ? `입찰 확정(${fmt(me?.bid||0)}원)` : "대기중";
      // (전환)
      await attemptSettleFromBid();
    }


    if(d.phase==="reveal_single"){
      show("#phaseChoose", false); show("#phaseBid", false); show("#revealBox", true); show("#mobileBidBar", false);
      const ul=$("#participantList"); ul.innerHTML="";
      const parts=d.participants||[];
      parts.forEach(name=>{
        const li=document.createElement("li");
        li.textContent = `${name} (단독 응찰)`;
        ul.appendChild(li);
      });
      // (전환) 2초 후 자동 정산
      if(!singleRevealTimerSet){
        singleRevealTimerSet=true;
        setTimeout(async ()=>{
          await settleSingleWinner();
          singleRevealTimerSet=false;
        }, 2000);
      }
    }


    // 결과 토스트 (1회)
    if(d.resultRound > lastSeenResultRound){
      lastSeenResultRound = d.resultRound;
      const myWin = (d.lastWinners||[]).includes(myName);
      if(myWin) toast(`${d.lastItem||"상품"} 획득!`, RESULT_IMG.success);
      else if(d.participantsBackup?.includes(myName)) toast(`낙찰 실패`, RESULT_IMG.fail);
      else                          toast(`불응찰 라운드 종료.`);
    }


  });


  /* ───────── 유저 입력 핸들러 ───────── */


  // 응찰/불응찰 확정
  $("#btnLockPart")?.addEventListener("click", async (e)=>{
    e.target.disabled=true;
    const choice = document.querySelector('input[name="part"]:checked')?.value;
    if(!choice){ alert("응찰 또는 불응찰을 선택하세요."); e.target.disabled=false; return; }
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="choose") return;
        const players=r.players.map(p=>{
          if(p.name===myName){
            return {...p, willParticipate:choice==="yes", readyPart:true, hold:0};
          }
          return p;
        });
        tx.update(ref, { players, updatedAt: serverTimestamp() });
      });
      // toast("확정됨"); // 스냅샷이 처리함
    }catch(e){ alert(`확정 실패: ${e.message||e}`); e.target.disabled=false; }
  });
  // (새로고침)
  $("#btnResyncPart")?.addEventListener("click", async ()=>{
    try{
      const s=await getDoc(ref); if(!s.exists()) return;
      const d=s.data();
      const me=(d.players||[]).find(p=>p.name===myName) || {};
      const canEdit = !(me.readyPart===true || me.ready===true);
      [...document.querySelectorAll('input[name="part"]')].forEach(r=> r.disabled = !canEdit);
      $("#btnLockPart").disabled = !canEdit || !(d.currentItem);
      $("#partStatus").textContent = me.readyPart||me.ready ?
        (me.willParticipate ? "응찰 참여 확정" : "불응찰 확정(+5만)") : "미확정";
      toast("상태를 새로고침했어요.");
    }catch(e){ alert(`새로고침 실패: ${e.message||e}`); }
  });


  // 입찰 확정/취소
  async function confirmBid(){
    const bidVal = snapToStep(stagedBid);
    const avail=(currentMe?.balance||0)+(currentMe?.hold||0);
    if(bidVal > avail){ alert(`소지금(${fmt(avail)}원)을 초과하여 입찰할 수 없습니다.`); return; }


    document.querySelectorAll("#btnConfirmBid, #btnConfirmBidMobile").forEach(b=>b.disabled=true);
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="bid") return;
        const players=r.players.map(p=>{
          if(p.name===myName){
            return {...p, bid:bidVal, readyBid:true, committed:true}; // committed: 구버전 호환
          }
          return p;
        });
        tx.update(ref, { players, updatedAt: serverTimestamp() });
      });
    }catch(e){ alert(`입찰 실패: ${e.message||e}`); document.querySelectorAll("#btnConfirmBid, #btnConfirmBidMobile").forEach(b=>b.disabled=false); }
  }
  async function cancelBid(){
    document.querySelectorAll("#btnCancelBid, #btnCancelBidMobile").forEach(b=>b.disabled=true);
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="bid") return;
        const players=r.players.map(p=>{
          if(p.name===myName){
            return {...p, bid:0, readyBid:false, committed:false};
          }
          return p;
        });
        tx.update(ref, { players, updatedAt: serverTimestamp() });
      });
    }catch(e){ alert(`취소 실패: ${e.message||e}`); document.querySelectorAll("#btnCancelBid, #btnCancelBidMobile").forEach(b=>b.disabled=false); }
  }
  $("#btnConfirmBid")?.addEventListener("click", confirmBid);
  $("#btnConfirmBidMobile")?.addEventListener("click", confirmBid);
  $("#btnCancelBid")?.addEventListener("click", cancelBid);
  $("#btnCancelBidMobile")?.addEventListener("click", cancelBid);


  // 결과 토스트 강제 재확인 (디버깅)
  // window.showResultToast=()=>{ const d=window.__lastRoomSnap; if(!d) return; const myWin = (d.lastWinners||[]).includes(myName); if(myWin) toast(`${d.lastItem||"상품"} 획득!`, RESULT_IMG.success); else if(d.participantsBackup?.includes(myName)) toast(`낙찰 실패`, RESULT_IMG.fail); else                          toast(`불응찰 라운드 종료.`); };


  // 상세 로그 내보내기(종료 후만 의미 있음)
  function downloadText(filename, text) {
    const el = document.createElement('a');
    el.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    el.setAttribute('download', filename);
    el.style.display = 'none'; document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  function toCSV(rows) {
    if (rows.length === 0) return "";
    const headers = Object.keys(rows[0]);
    const csv = [
      headers.join(','),
      ...rows.map(row => headers.map(h => JSON.stringify(row[h]||"")).join(','))
    ].join('\n');
    return csv;
  }


  $("#btnExportJSON")?.addEventListener("click", ()=>{
    const snap = window.__lastRoomSnap || {};
    const payload = {
      roomId,
      endedAt: snap?.endedAt?.toMillis?.() || null,
      finalWinners: snap?.finalWinners || [],
      victoryReason: snap?.victoryReason || "",
      logs: snap?.roundLogsDetailed || []
    };
    downloadText(`ulleung_game_${roomId}.json`, JSON.stringify(payload, null, 2));
  });
  $("#btnExportCSV")?.addEventListener("click", ()=>{
    const snap = window.__lastRoomSnap || {};
    const rows = (snap.roundLogsDetailed||[]).map(e=>(Object.assign({
      round: e.round,
      item: e.item,
      mode: e.mode,
      winningBid: e.winningBid||0,
      winners: (e.winners||[]).join(" / "),
      participants: (e.participants||[]).join(" / "),
      bids: Object.entries(e.bids||{}).map(([n,a])=>`${n}:${a}`).join(" | "),
      skipped: (e.skipped||[]).join(" / "),
      ts: e.ts
    }, e.bids||{}))); // bids를 플랫하게 추가
    if(rows.length===0){ alert("내보낼 로그가 없습니다."); return; }
    downloadText(`ulleung_game_${roomId}.csv`, toCSV(rows));
  });


</script>
</body>
</html>
