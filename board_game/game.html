<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 게임(game)</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module" id="fb-sdk">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };
  const ready=(async()=>{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .badge{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem}
  .card{background:#fff;border-radius:1rem;box-shadow:0 1px 3px rgb(0 0 0 / .06),0 1px 2px rgb(0 0 0 / .04)}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 게임</span></h1>
      <div class="text-sm text-slate-600 mt-1">
        Room <span id="roomId" class="mono">—</span> · Round <span id="round" class="mono">0</span>
        · You: <span id="you" class="font-medium"></span>
        · Role: <span id="role" class="font-medium">guest</span>
      </div>
    </div>
    <span id="badge" class="badge bg-slate-200">연결 준비중…</span>
  </header>

  <!-- 종료/안내 -->
  <div id="endedBox" class="hidden p-4 rounded border bg-emerald-50 border-emerald-200 text-emerald-800 text-sm">
    <span id="endMsg">게임이 종료되었습니다.</span>
  </div>

  <!-- 메인 레이아웃 -->
  <div id="grid" class="grid gap-4 lg:grid-cols-12">

    <!-- 내 정보 + 입찰 + 소지품 -->
    <section id="panelMe" class="card p-4 md:p-6 lg:col-span-6 xl:col-span-6">
      <h2 class="font-semibold mb-3">내 정보</h2>
      <div class="text-sm">닉네임: <span id="myName" class="font-medium"></span></div>
      <div class="text-sm mt-1">소지금: <span id="myBalance" class="mono font-bold">0</span>원</div>
      <div class="text-sm mt-1">보류금(확정된 입찰): <span id="myHold" class="mono font-bold">0</span>원</div>
      <div class="text-xs text-slate-500 mt-1">※ 다른 사람의 소지금은 보이지 않습니다.</div>

      <hr class="my-4">

      <h3 class="font-semibold mb-2">입찰</h3>
      <div class="flex items-center gap-2 mb-2 flex-wrap">
        <button data-delta="-1000000" class="shrink-0 w-14 md:w-16 px-2 py-1 rounded bg-slate-200 text-xs md:text-sm">-100만</button>
        <button data-delta="-100000"  class="shrink-0 w-14 md:w-16 px-2 py-1 rounded bg-slate-200 text-xs md:text-sm">-10만</button>
        <button data-delta="-10000"   class="shrink-0 w-14 md:w-16 px-2 py-1 rounded bg-slate-200 text-xs md:text-sm">-1만</button>
        <input id="bidInput" inputmode="numeric" class="mono w-32 md:w-40 border rounded px-3 py-2 text-right" placeholder="0" aria-label="입찰 금액(원)" />
        <button data-delta="10000"    class="shrink-0 w-14 md:w-16 px-2 py-1 rounded bg-slate-200 text-xs md:text-sm">+1만</button>
        <button data-delta="100000"   class="shrink-0 w-14 md:w-16 px-2 py-1 rounded bg-slate-200 text-xs md:text-sm">+10만</button>
        <button data-delta="1000000"  class="shrink-0 w-14 md:w-16 px-2 py-1 rounded bg-slate-200 text-xs md:text-sm">+100만</button>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnConfirmBid"  class="btn bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">확정</button>
        <button id="btnCancelBid"   class="btn bg-slate-300 hover:bg-slate-400 rounded px-4 py-2">확정 취소</button>
        <span id="myStatus" class="badge bg-slate-100">대기중</span>
      </div>

      <hr class="my-4">

      <h3 class="font-semibold mb-2">내 소지품</h3>
      <ul id="myItems" class="mt-2 space-y-2 text-sm"></ul>

      <div class="mt-4 p-3 rounded border bg-slate-50 text-sm">
        <div class="font-semibold mb-1">승리 조건</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>같은 종류 <b>3장</b></li>
          <li>서로 다른 종류 <b>4장</b></li>
          <li>아무거나 <b>5장</b></li>
        </ul>
        <div class="text-xs text-slate-500 mt-2">※ 소지품은 라운드 종료 시 낙찰자에게 자동 추가됩니다.</div>
      </div>
    </section>

    <!-- 플레이어 현황 -->
    <section id="panelPlayers" class="card p-4 md:p-6 lg:col-span-6 xl:col-span-6">
      <h2 class="font-semibold mb-3">플레이어 현황</h2>
      <div class="text-sm text-slate-600 mb-2">
        참가자 <span id="pCount" class="font-bold">0</span>명
        · 이번 상품: <span id="currentItem" class="font-medium">-</span>
        · 최근 상품: <span id="lastItem" class="font-medium">-</span>
        · <span>다음 라운드 수당: <b id="stipendAmount" class="mono">50,000</b>원</span>
      </div>
      <ul id="players" class="space-y-2 text-sm"></ul>
      <div class="text-xs text-slate-500 mt-2">※ 잔액은 각자만 확인합니다.</div>
    </section>

    <!-- 방장 컨트롤 -->
    <section id="hostPanel" class="hidden card p-4 md:p-6 lg:col-span-3 xl:col-span-3">
      <h2 class="font-semibold mb-3">방장 컨트롤</h2>

      <label class="text-sm block mb-1">이번 상품</label>
      <select id="roundItem" class="w-full border rounded px-3 py-2 mb-3">
        <option value="">— 선택 —</option>
        <option>오징어</option>
        <option>독도새우</option>
        <option>호박</option>
        <option>명이나물</option>
      </select>

      <div class="text-sm mb-3">라운드 수당: <b id="hostStipend" class="mono">50,000</b>원</div>

      <button id="btnEndRound" class="btn w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2 mb-2" disabled>
        라운드 종료 · 정산 + 수당 지급
      </button>

      <button id="btnEndGame" class="btn w-full bg-rose-600 hover:bg-rose-700 text-white rounded px-4 py-2">
        게임 종료(방 삭제)
      </button>

      <div id="errHost" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
    </section>
  </div>

  <!-- 라운드/시스템 알림 -->
  <div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded">
    <span id="toastMsg"></span>
  </div>
</div>

<script type="module">
  const $=s=>document.querySelector(s);
  const fmt=n=>Number(n||0).toLocaleString("ko-KR");
  const show=(id,yes)=>$(id).classList.toggle("hidden",!yes);
  const toast=(msg)=>{ $("#toastMsg").textContent=msg; $("#toast").classList.remove("hidden"); setTimeout(()=>$("#toast").classList.add("hidden"), 2200); };

  const params=new URL(location.href).searchParams;
  const roomId=(params.get("room")||"").toUpperCase();
  const myName=(params.get("name")||"").trim();
  $("#roomId").textContent=roomId||"—"; $("#you").textContent=myName||"—"; $("#myName").textContent=myName||"—";

  await window.firebaseReady;
  const { getFirestore, doc, getDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp,
          getAuth, signInAnonymously } = window.__fb;

  const db=getFirestore(), auth=getAuth();
  try{
    if(!auth.currentUser) await signInAnonymously(auth);
    $("#badge").textContent="연결됨"; $("#badge").className="badge bg-indigo-600 text-white";
  }catch(e){
    $("#badge").textContent="연결 실패"; $("#badge").className="badge bg-rose-600 text-white";
  }

  const ref=doc(db,"rooms",roomId);

  // ===== 입찰 상태 =====
  let stagedBid=0;
  const bidInput=$("#bidInput");
  const formatMoney = (n)=>fmt(Math.max(0, Math.floor(Number(n||0)/10000)*10000));
  const parseMoney  = (s)=>Number((s||"0").replace(/[^\d]/g,""))||0;
  function syncBidInput(){ bidInput.value = formatMoney(stagedBid); }
  syncBidInput();

  document.querySelectorAll("[data-delta]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const delta = Number(btn.getAttribute("data-delta"));
      const avail = (currentMe?.balance||0) + (currentMe?.hold||0);
      let next = stagedBid + delta;
      next = Math.max(0, Math.min(next, avail));
      next = Math.floor(next/10000)*10000;
      stagedBid = next; syncBidInput();
    });
  });
  bidInput.addEventListener("input", ()=>{ stagedBid = parseMoney(bidInput.value); });
  bidInput.addEventListener("blur", ()=>{
    const avail = (currentMe?.balance||0) + (currentMe?.hold||0);
    stagedBid = Math.max(0, Math.min(stagedBid, avail));
    stagedBid = Math.floor(stagedBid/10000)*10000;
    syncBidInput();
  });

  // ===== 실시간 상태 =====
  let isHost=false;
  let currentPlayers=[], currentMe=null;
  let lastSeenResultRound=0;

  function endUI(msg, winners=[]) {
    $("#endMsg").textContent = winners.length ? `게임 종료! 우승: ${winners.join(", ")}` : msg;
    $("#endedBox").classList.remove("hidden");
    $("#btnEndRound")?.setAttribute("disabled","true");
    $("#btnEndGame")?.setAttribute("disabled","true");
    $("#btnConfirmBid")?.setAttribute("disabled","true");
    $("#btnCancelBid")?.setAttribute("disabled","true");
    $("#roundItem")?.setAttribute("disabled","true");
  }

  function guessHost(roomData){
    const a = (roomData?.hostName||"").trim().toLowerCase();
    const b = (myName||"").trim().toLowerCase();
    const p1 = Array.isArray(roomData?.players) ? roomData.players[0] : null;
    const p1name = (p1?.name||"").trim().toLowerCase();
    return (a && a===b) || (p1name && p1name===b);
  }

  function applyLayout() {
    if (isHost) {
      $("#hostPanel").classList.remove("hidden");
      $("#panelMe").classList.remove("lg:col-span-6","xl:col-span-6");
      $("#panelPlayers").classList.remove("lg:col-span-6","xl:col-span-6");
      $("#panelMe").classList.add("lg:col-span-5","xl:col-span-4");
      $("#panelPlayers").classList.add("lg:col-span-7","xl:col-span-5");
    } else {
      $("#hostPanel").classList.add("hidden");
      $("#panelMe").classList.remove("lg:col-span-5","xl:col-span-4");
      $("#panelPlayers").classList.remove("lg:col-span-7","xl:col-span-5");
      $("#panelMe").classList.add("lg:col-span-6","xl:col-span-6");
      $("#panelPlayers").classList.add("lg:col-span-6","xl:col-span-6");
    }
  }

  function checkWin(items=[]) {
    const total = items.length;
    if (total >= 5) return "any5";
    const counts = {};
    for (const it of items) counts[it] = (counts[it]||0)+1;
    if (Object.values(counts).some(c=>c>=3)) return "same3";
    if (new Set(items).size >= 4) return "diff4";
    return "";
  }

  // 초기 로딩
  async function init() {
    const s=await getDoc(ref);
    if(!s.exists()){ endUI("방이 존재하지 않습니다."); return; }
    const r=s.data();
    if (r.gameOver) { endUI("게임이 종료되었습니다.", r.winners||[]); return; }
    isHost = guessHost(r);
    $("#role").textContent=isHost?"host":"guest";
    applyLayout();
    lastSeenResultRound = r.resultRound || 0;

    // 수당 표시 초기화
    const stipend = Number(r.stipend ?? 50000);
    $("#stipendAmount").textContent = fmt(stipend);
    $("#hostStipend").textContent = fmt(stipend);

    // 방장: 상품 선택 시 currentItem 실시간 반영
    if (isHost) {
      $("#hostPanel").classList.remove("hidden");
      $("#roundItem").addEventListener("change", async ()=>{
        const val = $("#roundItem").value;
        try{ await updateDoc(ref, { currentItem: val, updatedAt: serverTimestamp() }); }catch(_){}
      });
    }
  }
  await init();

  // 스냅샷 구독
  onSnapshot(ref, async (s)=>{
    if(!s.exists()){ endUI("방이 종료(삭제)되었습니다."); return; }
    const d=s.data();

    if (d.gameOver) { endUI("게임이 종료되었습니다.", d.winners||[]); }

    $("#round").textContent=d.round??0;
    $("#currentItem").textContent = d.currentItem || "-";
    $("#lastItem").textContent    = d.lastItem || "-";

    // 수당 표시 동기화
    const stipendNow = Number(d.stipend ?? 50000);
    $("#stipendAmount").textContent = fmt(stipendNow);
    $("#hostStipend").textContent = fmt(stipendNow);

    currentPlayers = Array.isArray(d.players) ? d.players : [];
    currentMe = currentPlayers.find(p=>p.name===myName) || null;

    $("#myBalance").textContent = fmt(currentMe?.balance||0);
    $("#myHold").textContent = fmt(currentMe?.hold||0);
    $("#myStatus").textContent = currentMe?.ready ? "준비됨" : "대기중";
    $("#myStatus").className = "badge " + (currentMe?.ready ? "bg-emerald-100" : "bg-slate-100");

    const myItems = Array.isArray(currentMe?.items) ? currentMe.items : [];
    const ulItems=$("#myItems"); ulItems.innerHTML="";
    myItems.forEach((it,i)=>{
      const li=document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.textContent = `${i+1}. ${it}`;
      ulItems.appendChild(li);
    });

    $("#pCount").textContent = currentPlayers.length.toString();
    const ul=$("#players"); ul.innerHTML="";
    currentPlayers.forEach((p,i)=>{
      const status = p.ready ? "준비" : "대기";
      const stClass = p.ready ? "bg-emerald-100" : "bg-slate-100";
      const li=document.createElement("li");
      li.className="flex items-center justify-between border rounded px-3 py-2";
      li.innerHTML = `
        <div class="flex items-center gap-2">
          <span>${i+1}. ${p.name}</span>
          <span class="badge ${stClass}">${status}</span>
        </div>
      `;
      ul.appendChild(li);
    });

    if (!d.gameOver && (d.resultRound||0) > lastSeenResultRound) {
      const winners = Array.isArray(d.lastWinners) ? d.lastWinners : [];
      const bidders = Array.isArray(d.lastBidders) ? d.lastBidders : [];
      if (winners.includes(myName)) {
        toast(`낙찰되었습니다! (${d.lastItem})`);
      } else if (bidders.includes(myName)) {
        toast(`낙찰 실패! 입찰 금액이 환불되었습니다.`);
      } else {
        toast(`라운드 종료: ${d.lastItem}`);
      }
      lastSeenResultRound = d.resultRound||0;
    }

    if (!d.gameOver) {
      isHost = guessHost(d);
      $("#role").textContent = isHost ? "host" : "guest";
      applyLayout();

      if (isHost) {
        if (d.currentItem !== undefined) $("#roundItem").value = d.currentItem || "";
        const everyoneReady = (Array.isArray(d.players) && d.players.length>0 && d.players.every(p=>p.ready===true));
        const itemChosen = !!(d.currentItem || $("#roundItem").value);
        $("#btnEndRound").disabled = !(everyoneReady && itemChosen);
      }
    }

    if (!d.gameOver) {
      const reason = checkWin(myItems);
      if (reason) {
        try{
          await updateDoc(ref, {
            gameOver: true,
            winners: Array.isArray(d.winners)&&d.winners.length ? d.winners : [myName],
            winReason: reason,
            updatedAt: serverTimestamp()
          });
          endUI("게임 종료!", [myName]);
        }catch(_){}
      }
    }
  });

  function showErr(msg){ const b=$("#errHost"); if(!b) return; b.textContent=msg; b.classList.remove("hidden"); }

  // --- 입찰 확정/취소 ---
  $("#btnConfirmBid").addEventListener("click", async ()=>{
    if(!currentMe) return;
    const avail = Number(currentMe.balance||0) + Number(currentMe.hold||0);
    let val = parseMoney($("#bidInput").value);
    val = Math.max(0, Math.min(val, avail));
    val = Math.floor(val/10000)*10000;
    stagedBid = val; syncBidInput();

    const newHold = stagedBid;
    const newBalance = avail - newHold;
    const players = currentPlayers.map(p => p.name===myName
      ? { ...p, hold:newHold, balance:newBalance, bid:newHold, committed:true, ready:true }
      : p
    );
    try{
      await updateDoc(ref, { players, updatedAt: serverTimestamp() });
    }catch(err){ alert(`확정 실패: ${err.message||err}`); }
  });

  $("#btnCancelBid").addEventListener("click", async ()=>{
    if(!currentMe) return;
    const refund = Number(currentMe.hold||0);
    const players = currentPlayers.map(p=> p.name===myName
      ? { ...p, balance:Number(p.balance||0)+refund, hold:0, bid:0, committed:false, ready:true }
      : p
    );
    stagedBid = 0; syncBidInput();
    try{
      await updateDoc(ref, { players, updatedAt: serverTimestamp() });
    }catch(err){ alert(`확정 취소 실패: ${err.message||err}`); }
  });

  // --- 방장: 라운드 종료 ---
  $("#btnEndRound").addEventListener("click", async ()=>{
    const snap = await getDoc(ref); if(!snap.exists()) return;
    const r = snap.data();
    const uiSel = ($("#roundItem").value || "").trim();
    const current = (r.currentItem && r.currentItem.trim()) || uiSel;
    if(!current) { alert("이번 상품을 선택하세요."); return; }

    try{
      let players = (r.players||[]).map(p=>({...p}));
      if (!players.every(p=>p.ready===true)) { alert("모든 플레이어가 확정/확정 취소를 완료해야 합니다."); return; }

      const maxHold = Math.max(0, ...players.map(p=>Number(p.hold||0)));
      const winners = players.filter(p=>Number(p.hold||0)===maxHold && maxHold>0).map(p=>p.name);
      const bidders = players.filter(p=>Number(p.hold||0)>0).map(p=>p.name);

      const stipend = Number(r.stipend ?? 50000);

      players = players.map(p=>{
        const hold = Number(p.hold||0);
        let balance = Number(p.balance||0);
        if (hold>0 && !winners.includes(p.name)) balance += hold; // 환불
        balance += stipend; // 수당 (서버값 사용)
        const items = Array.isArray(p.items)? [...p.items] : [];
        if (winners.includes(p.name)) items.push(current);
        return { ...p, balance, hold:0, bid:0, committed:false, ready:false, items };
      });

      await updateDoc(ref, {
        players,
        round: Number(r.round||0) + 1,
        lastItem: current,
        currentItem: "",
        lastWinners: winners,
        lastBidders: bidders,
        resultRound: Number(r.round||0) + 1,
        updatedAt: serverTimestamp()
      });
      $("#roundItem").value = "";
    }catch(err){
      showErr(`라운드 종료 실패: ${err.message||err}`);
    }
  });

  // 방장: 게임 종료(방 삭제)
  $("#btnEndGame").onclick = async ()=>{
    const ok = confirm("정말 게임을 종료하고 방을 삭제할까요?");
    if(!ok) return;
    try{ await deleteDoc(ref); }catch(err){ showErr(`삭제 실패: ${err.message||err}`); }
  };
</script>
</body>
</html>
