<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 참가(join.html)</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase (웹 클라이언트 전용) -->
<script type="module" id="fb-sdk">
  // ✅ 프로젝트의 Firebase 구성값(auction.html과 동일)
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };

  // SDK 로드 & 전역 주입
  const ready = (async () => {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    // (선택) Analytics
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch(_) {}

    window.__fb = { app, ...fs, ...au };
  })();

  // 외부에서 await 할 수 있게 노출
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 참가</span></h1>
    <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 준비중…</span>
  </header>

  <!-- 1) 방 정보/입장 -->
  <section id="view-join" class="bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">참가하기</h2>
    <div class="text-sm mb-2">Room <span id="room-id" class="mono">—</span></div>

    <label class="text-sm block mb-1">내 닉네임</label>
    <input id="nick" type="text" placeholder="예: 탐험가"
           class="w-full border rounded px-3 py-2 mb-3" />

    <button id="btn-join" type="button"
            class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2" disabled>
      입장
    </button>

    <p class="text-xs text-slate-500 mt-3">
      정원: 최소 3명, 최대 6명. 동일 닉네임은 사용할 수 없습니다.
    </p>

    <div id="err-join" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 2) 대기실 -->
  <section id="view-lobby" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-2">대기실</h2>
    <div class="text-sm mb-2">
      Room <span id="lobby-room" class="mono"></span> · 현재 <span id="count" class="font-bold">0</span>/6
    </div>
    <ul id="list" class="space-y-2 text-sm"></ul>

    <div id="startedBox" class="hidden mt-4 p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm">
      게임이 시작되었습니다! (본 게임 화면은 별도 페이지에서 이어집니다)
    </div>

    <div id="err-lobby" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

</div>

<script type="module">
  // ---------- 공통 ----------
  const $ = s => document.querySelector(s);
  const show = (id, yes) => $(id).classList.toggle("hidden", !yes);
  const setBadge = (t, cls) => { const b=$("#badge"); b.textContent=t; b.className=`text-xs px-2 py-1 rounded ${cls}`; };

  // room 파라미터 읽기
  const params = new URL(location.href).searchParams;
  const roomId = (params.get("room") || "").toUpperCase();
  $("#room-id").textContent = roomId || "—";

  if (!roomId) {
    $("#err-join").textContent = "잘못된 링크입니다. room 파라미터가 필요합니다.";
    $("#err-join").classList.remove("hidden");
    $("#btn-join").disabled = true;
  }

  await window.firebaseReady;
  const {
    getFirestore, doc, getDoc, updateDoc, onSnapshot, serverTimestamp,
    getAuth, signInAnonymously
  } = window.__fb;

  const db = getFirestore();
  const auth = getAuth();

  async function ensureAuth() {
    if (auth.currentUser) return;
    await signInAnonymously(auth);
  }

  function showErr(sel, msg) {
    const box = $(sel);
    box.textContent = msg;
    box.classList.remove("hidden");
  }

  // 최초 연결 시도
  try { await ensureAuth(); setBadge("연결됨", "bg-indigo-600 text-white"); }
  catch(e){ setBadge("연결 실패", "bg-rose-600 text-white"); showErr("#err-join", `익명 로그인 실패: ${e.code||""} ${e.message||""}`); }

  // 방 존재 확인 후 버튼 활성화
  try {
    if (roomId) {
      const ref = doc(db,"rooms",roomId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        showErr("#err-join", "존재하지 않는 방입니다. 링크를 확인하세요.");
      } else {
        $("#btn-join").disabled = false;
      }
    }
  } catch (e) {
    showErr("#err-join", `방 확인 실패: ${e.code||""} ${e.message||""}`);
  }

  // 입장 처리
  $("#btn-join").addEventListener("click", async () => {
    const name = ($("#nick").value || "").trim();
    if (!name) return showErr("#err-join", "닉네임을 입력하세요.");

    try {
      await ensureAuth();

      const ref = doc(db,"rooms",roomId);
      const snap = await getDoc(ref);
      if (!snap.exists()) throw new Error("존재하지 않는 방입니다.");

      const r = snap.data();
      const players = Array.isArray(r.players) ? [...r.players] : [];

      if (players.length >= 6) throw new Error("정원이 가득 찼습니다(6명).");
      if (players.some(p => p.name === name)) throw new Error("같은 닉네임이 이미 있습니다. 다른 이름을 입력하세요.");

      players.push({ id: `P${players.length+1}`, name });
      await updateDoc(ref, { players, updatedAt: serverTimestamp() });

      // 대기실로 전환 + 실시간 구독
      $("#lobby-room").textContent = roomId;
      show("#view-join", false);
      show("#view-lobby", true);

      onSnapshot(ref, (s) => {
        if (!s.exists()) return;
        const data = s.data();
        const list = data.players || [];
        $("#count").textContent = list.length;

        // 목록 렌더
        const ul = $("#list"); ul.innerHTML = "";
        list.forEach((p,i) => {
          const li = document.createElement("li");
          li.className = "flex items-center justify-between border rounded px-3 py-2";
          li.innerHTML = `<span>${i+1}. ${p.name}</span>`;
          ul.appendChild(li);
        });

        // 시작 안내
        if (data.started) $("#startedBox").classList.remove("hidden");
      });

    } catch (e) {
      showErr("#err-join", `입장 실패: ${e.code||""} ${e.message||e}`);
      console.error(e);
    }
  });
</script>
</body>
</html>
