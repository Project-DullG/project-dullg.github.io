<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>울릉 한 접시 · 참가(join)</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };

  // SDK 로드
  const ready = (async()=>{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-xl mx-auto p-4 md:p-6 space-y-6">
  <header class="flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">울릉 한 접시 <span class="text-slate-500">· 참가</span></h1>
    <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">연결 준비중…</span>
  </header>

  <!-- 참가 -->
  <section id="view-join" class="bg-white rounded-xl shadow p-4 md:p-6">
    <h2 class="font-semibold mb-3">참가하기</h2>
    <div class="text-sm mb-2">Room <span id="room" class="mono">—</span></div>

    <label class="text-sm block mb-1">내 닉네임</label>
    <input id="nick" type="text" placeholder="예: 탐험가" class="w-full border rounded px-3 py-2 mb-3" />

    <button id="btnJoin" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2" disabled>
      입장
    </button>

    <p class="text-xs text-slate-500 mt-3">정원: 최소 3명, 최대 8명(방장 포함). 동일 닉네임은 사용할 수 없습니다.</p>
    <div id="errJoin" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- 대기실 -->
  <section id="view-lobby" class="hidden bg-white rounded-xl shadow p-4 md:p-6">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">대기실</h2>
      <button id="btnLeave" class="btn bg-rose-600 hover:bg-rose-700 text-white rounded px-3 py-2 text-sm">나가기</button>
    </div>
    <div class="text-sm mb-2">
      Room <span id="lobbyRoom" class="mono"></span> · 현재 <span id="count" class="font-bold">0</span>/8
    </div>
    <ul id="list" class="space-y-2 text-sm"></ul>

    <div id="started" class="hidden mt-3 p-3 rounded bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm">
      게임이 시작되었습니다.
      <button id="goGame" class="ml-2 text-emerald-800 underline">게임 화면으로 이동</button>
    </div>
  </section>
</div>

<script type="module">
  const $ = s => document.querySelector(s);
  const show = (id, yes) => $(id).classList.toggle("hidden", !yes);
  const MAX_PLAYERS = 8;

  const params = new URL(location.href).searchParams;
  // ✅ 대소문자 보존: toUpperCase() 사용 안 함
  const roomId = (params.get("room") || "");
  $("#room").textContent = roomId || "—";

  await window.firebaseReady;
  const {
    getFirestore, doc, getDoc, updateDoc, onSnapshot, serverTimestamp, runTransaction,
    getAuth, signInAnonymously
  } = window.__fb;

  const db   = getFirestore();
  const auth = getAuth();

  async function ensureAuth() {
    if (!auth.currentUser) await signInAnonymously(auth);
  }

  function setBadge(t, ok=true){
    const b=$("#badge");
    b.textContent=t;
    b.className = "text-xs px-2 py-1 rounded " + (ok ? "bg-indigo-600 text-white" : "bg-rose-600 text-white");
  }

  function showErr(msg) {
    const box = $("#errJoin");
    box.textContent = msg;
    box.classList.remove("hidden");
  }
  function hideErr(){ $("#errJoin").classList.add("hidden"); }

  // 1) 인증
  try { await ensureAuth(); setBadge("연결됨", true); } 
  catch (e) { setBadge("연결 실패", false); showErr(`익명 로그인 실패: ${e.code||""} ${e.message||""}`); }

  // 2) 방 파라미터 체크
  let roomExists = false;
  let roomRef = null;

  if (!roomId) {
    showErr("잘못된 링크입니다. room 파라미터가 필요합니다.");
  } else {
    try {
      roomRef = doc(db, "rooms", roomId); // 대소문자 그대로
      const snap = await getDoc(roomRef);
      roomExists = snap.exists();
      if (!roomExists) {
        showErr("존재하지 않는 방입니다. 링크를 확인하세요.");
      }
    } catch (e) {
      showErr(`방 확인 실패: ${e.code||""} ${e.message||e}`);
    }
  }

  // 3) 버튼 활성화 로직
  function refreshJoinButton() {
    const hasName = ($("#nick").value || "").trim().length > 0;
    $("#btnJoin").disabled = !(roomExists && hasName);
  }
  $("#nick").addEventListener("input", ()=>{ hideErr(); refreshJoinButton(); });
  refreshJoinButton();

  // 복원(새로고침/이탈) 처리용 세션 스토리지
  const S_ROOM = "joinedRoomId";
  const S_NAME = "joinedName";

  // 나가기(플레이어 제거) 공통 함수
  async function leaveRoom({silent=false}={}){
    try{
      const joinedRoomId = sessionStorage.getItem(S_ROOM);
      const joinedName   = sessionStorage.getItem(S_NAME);
      if(!joinedRoomId || !joinedName) return;

      const ref = doc(db,"rooms", joinedRoomId);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) return;
        const r = snap.data();
        const players = Array.isArray(r.players) ? r.players.slice() : [];
        const next = players.filter(p => p.name !== joinedName);
        if (next.length !== players.length){
          tx.update(ref, { players: next, updatedAt: serverTimestamp() });
        }
      });

    }catch(e){
      if(!silent) showErr(`나가기 실패: ${e.message||e}`);
    }finally{
      sessionStorage.removeItem(S_ROOM);
      sessionStorage.removeItem(S_NAME);
      // 로비 페이지로 복귀
      const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
      location.href = baseDir + "room.html";
    }
  }

  // 페이지 이탈/새로고침 시 자동 이탈 시도
  window.addEventListener("beforeunload", (e)=>{
    // 백그라운드 트랜잭션은 보장되지 않지만, 최선을 다해 시도
    // fetch/keepalive 없이 Firestore는 완전 보장 못함 → 사용성 고려해 명시 버튼도 제공
    // 여기서는 조용히 시도만 하고 별도 confirm은 띄우지 않음.
    navigator.sendBeacon?.("__noop__", "1"); // 브라우저가 unload 최적화하는 경우 대비한 no-op
    // 별도 동기 호출 불가 → 실제 제거는 사용자가 '나가기'를 누르는 경로가 확실함
  });

  // 4) Enter로 즉시 입장 가능
  $("#nick").addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !$("#btnJoin").disabled) {
      $("#btnJoin").click();
    }
  });

  // 5) 입장 처리
  $("#btnJoin").addEventListener("click", async () => {
    hideErr();
    const name = ($("#nick").value || "").trim();
    if (!name) return showErr("닉네임을 입력하세요.");
    if (!roomExists || !roomRef) return showErr("방이 존재하지 않습니다.");

    try {
      await ensureAuth();
      // 트랜잭션으로 동시 입장 경합 처리
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(roomRef);
        if (!snap.exists()) throw new Error("존재하지 않는 방입니다.");
        const r = snap.data();

        if (r.started) throw new Error("이미 게임이 시작된 방입니다.");
        const players = Array.isArray(r.players) ? r.players.slice() : [];
        if (players.length >= MAX_PLAYERS) throw new Error("정원이 가득 찼습니다(8명).");
        if (players.some(p => p.name === name)) throw new Error("같은 닉네임이 이미 있습니다.");

        players.push({
          id: `P${players.length+1}`,
          name,
          balance: 1000000,
          hold: 0,
          bid: 0,
          committed: false,
          readyPart: false,
          readyBid: false,
          willParticipate: null,
          items: []
        });

        tx.update(roomRef, { players, updatedAt: serverTimestamp() });
      });

      // 세션 저장 → 복원/나가기용
      sessionStorage.setItem(S_ROOM, roomId);
      sessionStorage.setItem(S_NAME, name);

      // 대기실로 전환 + 실시간 구독
      $("#lobbyRoom").textContent = roomId;
      show("#view-join", false);
      show("#view-lobby", true);

      const unsub = onSnapshot(roomRef, (s) => {
        if (!s.exists()) {
          // 방이 삭제됨
          showErr("방이 삭제되었습니다.");
          sessionStorage.removeItem(S_ROOM);
          sessionStorage.removeItem(S_NAME);
          const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
          location.href = baseDir + "room.html";
          return;
        }
        const d = s.data();
        const list = d.players || [];
        $("#count").textContent = list.length;

        const ul = $("#list"); ul.innerHTML = "";
        list.forEach((p,i) => {
          const li = document.createElement("li");
          li.className = "flex items-center justify-between border rounded px-3 py-2";
          li.innerHTML = `<span>${i+1}. ${p.name}</span>`;
          ul.appendChild(li);
        });

        // 시작되면 게임 이동 버튼
        if (d.started) {
          $("#started").classList.remove("hidden");
          const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
          $("#goGame").onclick = () => {
            const u = new URL(baseDir + "game.html");
            u.searchParams.set("room", roomId);
            u.searchParams.set("name", sessionStorage.getItem(S_NAME) || name);
            location.href = u.toString();
          };
        } else {
          $("#started").classList.add("hidden");
        }

        // 참여자가 목록에 없는 경우(다른 곳에서 제거됨) → 로비로 복귀
        const meName = sessionStorage.getItem(S_NAME) || name;
        if (meName && !list.some(p=>p.name===meName)) {
          sessionStorage.removeItem(S_ROOM);
          sessionStorage.removeItem(S_NAME);
          unsub?.();
          const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
          location.href = baseDir + "room.html";
        }
      });

      // 나가기 버튼
      $("#btnLeave").onclick = async ()=>{ await leaveRoom(); };

    } catch (e) {
      showErr(`입장 실패: ${e.message||e}`);
      console.error(e);
    }
  });

  // 6) 새로고침/복원: 이미 참여 중이면 바로 대기실 UI로
  (async function tryRestore(){
    const jRoom = sessionStorage.getItem(S_ROOM);
    const jName = sessionStorage.getItem(S_NAME);
    if (!jRoom || !jName) return;
    try{
      const ref = doc(db,"rooms", jRoom);
      const snap = await getDoc(ref);
      if(!snap.exists()) {
        sessionStorage.removeItem(S_ROOM);
        sessionStorage.removeItem(S_NAME);
        return;
      }
      const d = snap.data();
      if (!Array.isArray(d.players) || !d.players.some(p=>p.name===jName)) {
        sessionStorage.removeItem(S_ROOM);
        sessionStorage.removeItem(S_NAME);
        return;
      }
      // 대기실 즉시 표시
      $("#lobbyRoom").textContent = jRoom;
      show("#view-join", false);
      show("#view-lobby", true);

      onSnapshot(ref, (s)=>{
        if(!s.exists()){
          sessionStorage.removeItem(S_ROOM);
          sessionStorage.removeItem(S_NAME);
          const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
          location.href = baseDir + "room.html";
          return;
        }
        const data = s.data();
        const list = data.players || [];
        $("#count").textContent = list.length;
        const ul = $("#list"); ul.innerHTML="";
        list.forEach((p,i)=>{
          const li=document.createElement("li");
          li.className="flex items-center justify-between border rounded px-3 py-2";
          li.innerHTML=`<span>${i+1}. ${p.name}</span>`;
          ul.appendChild(li);
        });

        if (data.started) {
          $("#started").classList.remove("hidden");
          const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
          $("#goGame").onclick = () => {
            const u = new URL(baseDir + "game.html");
            u.searchParams.set("room", jRoom);
            u.searchParams.set("name", jName);
            location.href = u.toString();
          };
        } else {
          $("#started").classList.add("hidden");
        }

        if (!list.some(p=>p.name===jName)) {
          // 내가 제거되었음
          sessionStorage.removeItem(S_ROOM);
          sessionStorage.removeItem(S_NAME);
          const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
          location.href = baseDir + "room.html";
        }
      });

      $("#btnLeave").onclick = async ()=>{ await leaveRoom(); };

    }catch(e){
      // 복원 실패해도 치명적이지 않음
      console.warn("restore failed:", e);
    }
  })();
</script>
</body>
</html>
