<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<title>ìš°ë¦¬ê°€ ì´ê¹€ Â· ë°©(lobby)</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase (ëª¨ë“ˆ) -->
<script type="module" id="fb-sdk">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };

  const ready = (async () => {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .title-img{max-width:320px;width:100%;border-radius:1rem;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
</style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 text-slate-900 min-h-screen">
<div class="max-w-4xl mx-auto p-4 md:p-6 space-y-6">

  <header class="flex flex-col items-center gap-4">
    <img src="title.jpeg" alt="ìš°ë¦¬ê°€ ì´ê¹€" class="title-img" />
    <div class="flex items-center gap-3">
      <h1 class="text-xl md:text-2xl font-bold text-orange-800">ìš°ë¦¬ê°€ ì´ê¹€ <span class="text-orange-500">Â· ë°©</span></h1>
      <span id="badge" class="text-xs px-2 py-1 rounded bg-slate-200">ì—°ê²° ì¤€ë¹„ì¤‘â€¦</span>
    </div>
  </header>

  <!-- ì´ë¯¸ ë§Œë“¤ì–´ì§„ ë°©ìœ¼ë¡œ ì…ì¥ -->
  <section id="view-list" class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-orange-200">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-orange-700">ì´ë¯¸ ë§Œë“¤ì–´ì§„ ë°©ìœ¼ë¡œ ì…ì¥</h2>
      <div class="text-xs text-slate-500">ì§„í–‰ ì „ ë°©ë§Œ í‘œì‹œ Â· ì‹¤ì‹œê°„</div>
    </div>

    <div class="flex items-center justify-between mb-2">
      <button id="btnRefresh" class="btn bg-orange-200 hover:bg-orange-300 rounded px-3 py-2 text-sm">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
      <span class="text-xs text-slate-500">* ì§„í–‰ ì¤‘/ì¢…ë£Œ ë°©ì€ ì…ì¥ ë¶ˆê°€</span>
    </div>

    <div id="roomsEmpty" class="hidden text-sm text-slate-500 border rounded p-3 bg-orange-50">
      í˜„ì¬ ì…ì¥ ê°€ëŠ¥í•œ ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì–´ ì‹œì‘í•´ ë³´ì„¸ìš”!
    </div>

    <ul id="roomsList" class="grid gap-3 md:grid-cols-2"></ul>

    <div id="errJoinList" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- ìƒˆ ë°© ë§Œë“¤ê¸° -->
  <section id="view-create" class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-orange-200">
    <h2 class="font-semibold mb-3 text-orange-700">ìƒˆ ë°© ë§Œë“¤ê¸°</h2>

    <label class="text-sm block mb-1">ë‚´ ë‹‰ë„¤ì„(ë°©ì¥)</label>
    <input id="hostName" type="text" placeholder="ì˜ˆ: ì´ê¹€ì™•" class="w-full border border-orange-300 rounded px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-orange-400" />

    <!-- ì§„í–‰ ë°©ì‹ ì„ íƒ -->
    <div class="mb-3 text-sm space-y-2">
      <div class="font-medium">ì§„í–‰ ë°©ì‹</div>
      <label class="flex items-center gap-2">
        <input type="radio" name="mode" value="board" checked>
        <span>ë³´ë“œê²Œì„ ì¹´ë“œ ì‚¬ìš©(ë§¤ ë¼ìš´ë“œ ë°©ì¥ì´ ì¹´ë“œ ìˆ˜ë™ ë“±ë¡)</span>
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="mode" value="web">
        <span>ì›¹ ì „ìš©(ì¹´ë“œ ìë™ ê²°ì •)</span>
      </label>
    </div>

    <button id="btnCreate" class="btn w-full bg-orange-500 hover:bg-orange-600 text-white rounded px-4 py-2 font-semibold" disabled>
      ë°© ë§Œë“¤ê¸°
    </button>
    <div id="errCreate" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- ë°©ì¥: ê³µìœ /ëŒ€ê¸° -->
  <section id="view-host" class="hidden bg-white rounded-xl shadow-lg p-4 md:p-6 border border-orange-200">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold text-orange-700">Room <span id="roomId" class="mono"></span></h2>
      <div class="text-sm">ì°¸ê°€ì <span id="count" class="font-bold">0</span> / <span id="maxPlayers">8</span></div>
    </div>

    <div class="text-xs text-slate-600 mt-1" id="modeInfo"></div>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div class="border border-orange-200 rounded-lg p-4 bg-orange-50">
        <h3 class="font-semibold mb-2">ì°¸ê°€ ë§í¬ ê³µìœ </h3>
        <div class="flex items-center gap-2">
          <input id="shareLink" class="w-full border rounded px-3 py-2 text-xs" readonly />
          <button id="btnCopy" class="btn bg-orange-600 text-white rounded px-3 py-2">ë³µì‚¬</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">ìµœëŒ€ 8ëª… ì ‘ì†. <b>3ëª… ì´ìƒ</b>ì´ë©´ ì‹œì‘ ê°€ëŠ¥.</p>
      </div>

      <div class="border border-orange-200 rounded-lg p-4">
        <h3 class="font-semibold mb-2">ëŒ€ê¸° ì¤‘ ì°¸ê°€ì</h3>
        <ul id="waitList" class="space-y-2 text-sm"></ul>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <button id="btnStart" class="btn bg-orange-500 disabled:bg-orange-500/50 text-white rounded px-4 py-2 font-semibold" disabled>
        ì‹œì‘í•˜ê¸°
      </button>
      <span class="text-xs text-slate-600">3â€“8ëª…ì—ì„œ ì‹œì‘ ê°€ëŠ¥</span>
    </div>

    <!-- ë°© ì‚­ì œ -->
    <div class="mt-2">
      <button id="btnDeleteRoom" class="btn bg-rose-600 hover:bg-rose-700 text-white rounded px-4 py-2">ë°© ì‚­ì œ</button>
    </div>

    <div id="errHost" class="hidden mt-3 p-3 rounded bg-rose-50 border border-rose-200 text-rose-700 text-sm"></div>
  </section>

  <!-- ê²Œì„ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° -->
  <section class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-orange-200">
    <h2 class="font-semibold mb-3 text-orange-700">ê²Œì„ ì¹´ë“œ</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
      <div class="text-center">
        <img src="banana.png" alt="ì¤€ì˜ì´ì˜ ë°”ë‚˜ë‚˜" class="w-14 h-14 sm:w-16 sm:h-16 mx-auto rounded-lg object-cover border-2 border-yellow-400" />
        <p class="text-[10px] sm:text-xs mt-1">ì¤€ì˜ì´ì˜ ë°”ë‚˜ë‚˜</p>
      </div>
      <div class="text-center">
        <img src="clover.png" alt="ë³´ê¸ˆì´ì˜ í´ë¡œë²„ë¥¼ ë“  í•˜ì˜ì´" class="w-14 h-14 sm:w-16 sm:h-16 mx-auto rounded-lg object-cover border-2 border-green-400" />
        <p class="text-[10px] sm:text-xs mt-1 leading-tight">ë³´ê¸ˆì´ì˜ í´ë¡œë²„ë¥¼ ë“  í•˜ì˜ì´</p>
      </div>
      <div class="text-center">
        <img src="king.png" alt="í‚¹ ì‹ ì›… êµìˆ˜ë‹˜" class="w-14 h-14 sm:w-16 sm:h-16 mx-auto rounded-lg object-cover border-2 border-purple-400" />
        <p class="text-[10px] sm:text-xs mt-1">í‚¹ ì‹ ì›… êµìˆ˜ë‹˜</p>
      </div>
      <div class="text-center">
        <img src="politics.jpeg" alt="ë‘ ì •ì¹˜ ì„¸ë ¥" class="w-14 h-14 sm:w-16 sm:h-16 mx-auto rounded-lg object-cover border-2 border-blue-400" />
        <p class="text-[10px] sm:text-xs mt-1">ë‘ ì •ì¹˜ ì„¸ë ¥</p>
      </div>
      <div class="text-center">
        <img src="joker.jpeg" alt="ì¡°ì»¤ ì´ì„±ë¡œ" class="w-14 h-14 sm:w-16 sm:h-16 mx-auto rounded-lg object-cover border-2 border-red-500 ring-2 ring-red-300" />
        <p class="text-[10px] sm:text-xs mt-1 text-red-600 font-bold">ì¡°ì»¤ ì´ì„±ë¡œ</p>
        <p class="text-[9px] sm:text-[10px] text-slate-500">í¬ê·€! ì™€ì¼ë“œì¹´ë“œ</p>
      </div>
    </div>
  </section>

  <!-- ê²Œì„ ì„¤ëª… ìš”ì•½ -->
  <section class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl shadow-lg p-4 md:p-6 text-white">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-lg">ê²Œì„ ë°©ë²•</h2>
      <a href="rules.html" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full text-sm transition">ìì„¸íˆ ë³´ê¸° â†’</a>
    </div>

    <div class="grid sm:grid-cols-3 gap-4 text-sm">
      <div class="bg-white/10 rounded-lg p-3">
        <div class="font-bold mb-1">ğŸ¯ ëª©í‘œ</div>
        <p class="text-white/90 text-xs">ì¹´ë“œë¥¼ ëª¨ì•„ ìŠ¹ë¦¬ ì¡°ê±´ ë‹¬ì„±!</p>
      </div>
      <div class="bg-white/10 rounded-lg p-3">
        <div class="font-bold mb-1">ğŸ’° ì´ˆê¸° ìê¸ˆ</div>
        <p class="text-white/90 text-xs">100ë§Œì›ìœ¼ë¡œ ì‹œì‘</p>
      </div>
      <div class="bg-white/10 rounded-lg p-3">
        <div class="font-bold mb-1">ğŸ‘¥ ì¸ì›</div>
        <p class="text-white/90 text-xs">3~8ëª…</p>
      </div>
    </div>

    <div class="mt-4 bg-white/10 rounded-lg p-3">
      <div class="font-bold mb-2">ğŸ† ìŠ¹ë¦¬ ì¡°ê±´</div>
      <div class="grid grid-cols-3 gap-2 text-xs text-center">
        <div class="bg-white/10 rounded p-2">
          <div class="font-bold">ê°™ì€ ì¹´ë“œ</div>
          <div class="text-2xl">3ê°œ</div>
        </div>
        <div class="bg-white/10 rounded p-2">
          <div class="font-bold">ë‹¤ë¥¸ ì¹´ë“œ</div>
          <div class="text-2xl">4ê°œ</div>
        </div>
        <div class="bg-white/10 rounded p-2">
          <div class="font-bold">ì•„ë¬´ ì¹´ë“œ</div>
          <div class="text-2xl">5ê°œ</div>
        </div>
      </div>
      <p class="text-[10px] text-white/70 mt-2 text-center">* ì¡°ì»¤ëŠ” ì–´ë–¤ ì¹´ë“œë¡œë„ ëŒ€ì²´ ê°€ëŠ¥!</p>
    </div>

    <div class="mt-4 text-xs space-y-1 text-white/90">
      <p>1ï¸âƒ£ <b>ì‘ì°° ì„ íƒ:</b> ì°¸ì—¬ ë˜ëŠ” ë¶ˆì‘ì°°(+5ë§Œì›)</p>
      <p>2ï¸âƒ£ <b>ë¹„ê³µê°œ ì…ì°°:</b> ëª°ë˜ ê¸ˆì•¡ ì…ë ¥</p>
      <p>3ï¸âƒ£ <b>ë‚™ì°°:</b> ìµœê³ ê°€ ì…ì°°ìê°€ ì¹´ë“œ íšë“!</p>
    </div>
  </section>
</div>

<script type="module">
  const $ = s => document.querySelector(s);
  const show = (sel, yes) => $(sel).classList.toggle("hidden", !yes);
  const setBadge=(t,c)=>{const b=$("#badge");b.textContent=t;b.className=`text-xs px-2 py-1 rounded ${c}`};

  await window.firebaseReady;
  const {
    getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, getDocs,
    collection, serverTimestamp,
    getAuth, signInAnonymously
  } = window.__fb;

  const db=getFirestore(), auth=getAuth();
  async function ensureAuth(){ if(!auth.currentUser) await signInAnonymously(auth) }

  // ì—°ê²°
  try{ await ensureAuth(); setBadge("ì—°ê²°ë¨","bg-orange-500 text-white"); $("#btnCreate").disabled=false; }
  catch{ setBadge("ì—°ê²° ì‹¤íŒ¨","bg-rose-600 text-white"); }

  // ===== ë°© ëª©ë¡ =====
  const MAX_PLAYERS = 8;
  $("#maxPlayers").textContent = MAX_PLAYERS;

  const listEl = $("#roomsList");
  const errJoinList = $("#errJoinList");

  function roomCard({id, hostName, players=[], started=false, boardMode}) {
    const count = Array.isArray(players) ? players.length : 0;
    const disabled = started || count>=MAX_PLAYERS;
    const modeLabel = boardMode ? "ë³´ë“œê²Œì„" : "ì›¹ ì „ìš©";
    return `
      <li class="border border-orange-200 rounded-lg p-3 flex flex-col gap-2 bg-gradient-to-br from-white to-orange-50">
        <div class="flex items-center justify-between">
          <div class="text-sm">
            <div class="font-semibold text-orange-700">Room <span class="mono">${id}</span></div>
            <div class="text-xs text-slate-500">ë°©ì¥: ${hostName || "-"}</div>
          </div>
          <div class="text-right text-xs text-slate-600">
            <div>${started ? "ì§„í–‰ì¤‘" : "ëŒ€ê¸°ì¤‘"}</div>
            <div class="text-slate-400">${modeLabel}</div>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-sm">ì¸ì›: <b>${count}</b> / ${MAX_PLAYERS}</div>
          <button data-join="${id}" class="btn bg-orange-500 hover:bg-orange-600 text-white rounded px-3 py-1.5 text-sm"
            ${disabled ? "disabled" : ""}>ì…ì¥</button>
        </div>
      </li>
    `;
  }

  async function refreshRoomsOnce(){
    try{
      errJoinList.classList.add("hidden");
      const snap = await getDocs(collection(db,"wewin_rooms"));
      const all = [];
      snap.forEach(docu=>{
        const d=docu.data();
        all.push({
          id: d.id || docu.id,
          hostName: d.hostName,
          players: d.players||[],
          started: !!d.started,
          gameOver: d.gameOver===true,
          createdAt: d.createdAt?.toMillis?.() || 0,
          boardMode: d.boardMode===true
        });
      });
      const rooms = all.filter(r=>!r.started && !r.gameOver)
                       .sort((a,b)=>b.createdAt - a.createdAt)
                       .slice(0,20);

      listEl.innerHTML = rooms.map(roomCard).join("");
      $("#roomsEmpty").classList.toggle("hidden", rooms.length!==0);

      // ë²„íŠ¼ ë°”ì¸ë”© â†’ join.htmlë¡œ ì´ë™
      listEl.querySelectorAll("[data-join]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const roomId = btn.getAttribute("data-join");
          try{
            const ref = doc(db,"wewin_rooms",roomId);
            const snap = await getDoc(ref);
            if(!snap.exists()) throw new Error("ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            const r=snap.data();
            const count = Array.isArray(r.players)? r.players.length : 0;
            if (r.started || r.gameOver) throw new Error("ì´ë¯¸ ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì¢…ë£Œëœ ë°©ì…ë‹ˆë‹¤.");
            if (count >= MAX_PLAYERS) throw new Error("ì •ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
            const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
            const url = new URL(baseDir + "join.html");
            url.searchParams.set("room", roomId);
            location.href = url.toString();
          }catch(e){
            errJoinList.textContent = e.message || e;
            errJoinList.classList.remove("hidden");
            refreshRoomsOnce();
          }
        });
      });
    }catch(e){
      errJoinList.textContent = `ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${e.message||e}`;
      errJoinList.classList.remove("hidden");
    }
  }
  onSnapshot(collection(db,"wewin_rooms"), ()=> refreshRoomsOnce());
  $("#btnRefresh").addEventListener("click", refreshRoomsOnce);
  refreshRoomsOnce();

  // ===== ë‚´ ë°© ë³µì› & ì¤‘ë³µ ìƒì„± ë°©ì§€ =====
  const ownRoomIdStorageKey = "wewin_ownRoomId";
  let ownRoomId = localStorage.getItem(ownRoomIdStorageKey) || "";

  async function bindHostRealtime(ref){
    onSnapshot(ref, (s)=>{
      if(!s.exists()){
        show("#view-host", false);
        show("#view-list", true);
        show("#view-create", true);
        localStorage.removeItem(ownRoomIdStorageKey);
        ownRoomId = "";
        refreshRoomsOnce();
        return;
      }
      const data = s.data();
      const ul=$("#waitList"); ul.innerHTML="";
      (data.players||[]).forEach((p,i)=>{
        const li=document.createElement("li");
        li.className="flex items-center justify-between border border-orange-200 rounded px-3 py-2 bg-orange-50";
        li.innerHTML=`<span>${i+1}. ${p.name}</span>`;
        ul.appendChild(li);
      });
      const n=(data.players||[]).length;
      $("#count").textContent=n;
      $("#btnStart").disabled=!(n>=3 && n<=MAX_PLAYERS);

      $("#modeInfo").textContent = data.boardMode ? "ì§„í–‰ ë°©ì‹: ë³´ë“œê²Œì„(ìˆ˜ë™ ì¹´ë“œ ë“±ë¡)" : "ì§„í–‰ ë°©ì‹: ì›¹ ì „ìš©(ìë™ ì¹´ë“œ)";
    });
  }

  async function bindStartButton(roomId){
    $("#btnStart").onclick = async ()=>{
      try{
        const ref=doc(db,"wewin_rooms",roomId);
        const snap=await getDoc(ref);
        if(!snap.exists()) return;
        const r=snap.data(); const n=(r.players||[]).length;
        if(n<3 || n>MAX_PLAYERS) return;
        await updateDoc(ref,{ started:true, updatedAt:serverTimestamp() });
        const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
        const gameUrl = new URL(baseDir + "game.html");
        gameUrl.searchParams.set("room", roomId);
        gameUrl.searchParams.set("name", r.hostName || "");
        location.href = gameUrl.toString();
      }catch(e){
        $("#errHost").textContent=`ì‹œì‘ ì‹¤íŒ¨: ${e.message||e}`; $("#errHost").classList.remove("hidden");
      }
    };
  }

  function bindDeleteButton(ref){
    $("#btnDeleteRoom").onclick = async ()=>{
      try{
        await deleteDoc(ref);
        localStorage.removeItem(ownRoomIdStorageKey);
        ownRoomId = "";
        alert("ë°©ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
        show("#view-host", false);
        show("#view-list", true);
        show("#view-create", true);
        refreshRoomsOnce();
      }catch(e){
        $("#errHost").textContent=`ì‚­ì œ ì‹¤íŒ¨: ${e.message||e}`;
        $("#errHost").classList.remove("hidden");
      }
    };
  }

  async function tryRestoreOwnRoom(){
    if(!ownRoomId) return false;
    const ref = doc(db,"wewin_rooms", ownRoomId);
    const snap = await getDoc(ref);
    if(!snap.exists() || snap.data().gameOver===true){
      localStorage.removeItem(ownRoomIdStorageKey);
      ownRoomId = "";
      return false;
    }
    show("#view-list", false);
    show("#view-create", false);
    $("#roomId").textContent = ownRoomId;
    $("#shareLink").value = snap.data().link || "";
    show("#view-host", true);

    await bindHostRealtime(ref);
    await bindStartButton(ownRoomId);
    bindDeleteButton(ref);
    return true;
  }
  const restored = await tryRestoreOwnRoom();

  // ===== ì´ë¦„ìœ¼ë¡œ ë°© ID ë§Œë“¤ê¸° =====
  async function makeRoomIdFromName(name){
    const base = `${name}ì˜ ë°©`;
    let candidate = base;
    let idx = 2;
    while(true){
      const ref = doc(db,"wewin_rooms", candidate);
      const snap = await getDoc(ref);
      if(!snap.exists()) return candidate;
      candidate = `${base} ${idx++}`;
      if(idx>99) return `${base} ${Date.now()}`;
    }
  }

  // ===== ìƒˆ ë°© ë§Œë“¤ê¸° =====
  $("#btnCreate").addEventListener("click", async ()=>{
    if(ownRoomId){
      const errBox=$("#errCreate");
      errBox.textContent="ì´ë¯¸ ìƒì„±í•œ ë°©ì´ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ ë°©ì—ì„œ ì§„í–‰í•˜ê±°ë‚˜ ë°©ì„ ì‚­ì œí•œ í›„ ìƒˆë¡œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.";
      errBox.classList.remove("hidden");
      return;
    }
    const name = ($("#hostName").value||"").trim();
    const errBox=$("#errCreate");
    if(!name){ errBox.textContent="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."; errBox.classList.remove("hidden"); return; }

    const boardMode = (document.querySelector('input[name="mode"]:checked')?.value === 'board');

    const roomId = await makeRoomIdFromName(name);
    const baseDir = location.origin + location.pathname.replace(/[^/]+$/, "");
    const joinUrl = new URL(baseDir + "join.html"); joinUrl.searchParams.set("room", roomId);

    const room = {
      id: roomId,
      hostName: name,
      link: joinUrl.toString(),
      started: false,
      gameOver: false,
      round: 0,
      boardMode: boardMode,
      players: [
        { id:"P1", name, balance:1000000, hold:0, bid:0, committed:false, readyPart:false, readyBid:false, willParticipate:null, items:[] }
      ],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    try{
      await ensureAuth();
      const ref = doc(db,"wewin_rooms",roomId);
      await setDoc(ref, room);

      ownRoomId = roomId;
      localStorage.setItem(ownRoomIdStorageKey, ownRoomId);

      show("#view-list", false);
      show("#view-create", false);
      $("#roomId").textContent = roomId;
      $("#shareLink").value = joinUrl.toString();
      show("#view-host", true);

      await bindHostRealtime(ref);
      await bindStartButton(roomId);
      bindDeleteButton(ref);

      $("#btnCopy").onclick = async ()=>{
        try{ await navigator.clipboard.writeText(joinUrl.toString());
             const btn=$("#btnCopy"); btn.textContent="ë³µì‚¬ë¨!"; setTimeout(()=>btn.textContent="ë³µì‚¬",1200);
        }catch(e){ $("#errHost").textContent=`ë³µì‚¬ ì‹¤íŒ¨: ${e.message||e}`; $("#errHost").classList.remove("hidden"); }
      };

      // 15ë¶„ ë¯¸ì‹œì‘ ìë™ ì‚­ì œ
      setTimeout(async ()=>{
        try{
          const snap = await getDoc(ref);
          if (snap.exists() && !snap.data().started) {
            await deleteDoc(ref);
            localStorage.removeItem(ownRoomIdStorageKey);
            ownRoomId = "";
            alert("15ë¶„ ë™ì•ˆ ì‹œì‘ë˜ì§€ ì•Šì•„ ë°©ì´ ìë™ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            show("#view-host", false); show("#view-list", true); show("#view-create", true);
            refreshRoomsOnce();
          }
        }catch(e){ console.warn("auto-clean failed:", e); }
      }, 15 * 60 * 1000);

    }catch(e){
      errBox.textContent=`ë°© ìƒì„± ì‹¤íŒ¨: ${e.code||""} ${e.message||e}`; errBox.classList.remove("hidden");
    }
  });

  if (!restored) {
    show("#view-host", false);
    show("#view-list", true);
    show("#view-create", true);
  }
</script>
</body>
</html>
