<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ìš°ë¦¬ê°€ ì´ê¹€ Â· ê²Œì„(game)</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module" id="fb-sdk">
  const firebaseConfig = {
    apiKey: "AIzaSyBwHIITHru4Od1fjwg6OOMNTjRFbvwpVkg",
    authDomain: "boardgame-1a3dd.firebaseapp.com",
    projectId: "boardgame-1a3dd",
    storageBucket: "boardgame-1a3dd.firebasestorage.app",
    messagingSenderId: "278191503167",
    appId: "1:278191503167:web:a02892e0d742e12339058a",
    measurementId: "G-0EQB5WN6QE"
  };
  const ready=(async()=>{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js");
    const app = initializeApp(firebaseConfig);
    const fs  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
    const au  = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
    try { const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js"); getAnalytics(app); } catch {}
    window.__fb = { app, ...fs, ...au };
  })();
  window.firebaseReady = ready;
</script>

<style>
  .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum";}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .badge{font-size:.75rem;padding:.125rem .5rem;border-radius:.375rem}
  .card{background:#fff;border-radius:1rem;box-shadow:0 2px 8px rgb(0 0 0 / .08);border:1px solid rgb(253 186 116 / .5);}
  .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom,0) + 90px);}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.5rem;border:1px solid rgb(253 186 116);background:#fffbeb;padding:.5rem}
  .icon-btn svg{width:16px;height:16px}
  .item-img{width:48px;height:48px;object-fit:cover;border-radius:8px;border:2px solid #fb923c;}
  .joker-border{border-color:#ef4444 !important;box-shadow:0 0 8px rgba(239,68,68,.4);}
</style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 text-slate-900 safe-bottom min-h-screen">
<div class="max-w-7xl mx-auto p-3 md:p-6 space-y-4 md:space-y-6">

  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
    <div>
      <h1 class="text-lg md:text-2xl font-bold text-orange-800">ìš°ë¦¬ê°€ ì´ê¹€ <span class="text-orange-500">Â· ê²Œì„</span></h1>
      <div class="text-xs sm:text-sm text-slate-600 mt-1 flex flex-wrap gap-x-2">
        <span>Room <span id="roomId" class="mono">â€”</span></span>
        <span>Round <span id="round" class="mono">0</span></span>
        <span>You: <span id="you" class="font-medium"></span></span>
        <span>Role: <span id="role" class="font-medium">guest</span></span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <a href="rules.html" class="text-xs text-orange-600 underline">ê·œì¹™</a>
      <span id="badge" class="badge bg-slate-200">ì—°ê²° ì¤€ë¹„ì¤‘â€¦</span>
    </div>
  </header>

  <div id="endedBox" class="hidden p-4 rounded-xl border-2 bg-gradient-to-r from-emerald-50 to-green-100 border-emerald-300 text-emerald-800 text-sm">
    <span id="endMsg">ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span>
    <a id="btnReplay" href="room.html" class="ml-3 underline font-semibold">ë‹¤ì‹œí•˜ê¸°</a>
  </div>

  <!-- ë°©ì¥ ì „ìš©: ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ -->
  <div id="hostEndBox" class="hidden p-3 rounded-xl border border-rose-200 bg-rose-50 flex items-center justify-between">
    <span class="text-sm text-rose-700">ë°©ì¥ ì „ìš©</span>
    <button id="btnEndGame" class="btn bg-rose-600 hover:bg-rose-700 text-white rounded px-4 py-2 text-sm">ê²Œì„ ì¢…ë£Œ</button>
  </div>

  <div id="grid" class="grid gap-4 lg:grid-cols-12">

    <!-- ë‚´ ì •ë³´ + ë‹¨ê³„ ì•¡ì…˜ -->
    <section id="panelMe" class="card p-4 md:p-6 lg:col-span-5 xl:col-span-4">
      <h2 class="font-semibold mb-3 text-orange-700">ë‚´ ì •ë³´</h2>
      <div class="text-sm">ë‹‰ë„¤ì„: <span id="myName" class="font-medium"></span></div>
      <div class="text-sm mt-1">ì†Œì§€ê¸ˆ: <span id="myBalance" class="mono font-bold text-orange-600">0</span>ì›</div>
      <div class="text-sm mt-1">ë³´ë¥˜ê¸ˆ: <span id="myHold" class="mono font-bold">0</span>ì›</div>

      <hr class="my-4 border-orange-200">

      <!-- 1ë‹¨ê³„: ì‘ì°° ì„ íƒ -->
      <div id="phaseChoose" class="space-y-3">
        <h3 class="font-semibold text-orange-700">1) ì‘ì°° ì—¬ë¶€ ì„ íƒ</h3>
        <div class="text-sm flex items-center gap-2">
          ì´ë²ˆ ì¹´ë“œ: <b id="currentItemMe">-</b>
          <img id="imgCurrentMe" alt="" class="item-img" style="display:none;">
        </div>

        <div class="flex items-center gap-4 mt-2">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="part" value="yes" /> ì‘ì°° ì°¸ì—¬
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="part" value="no" /> ë¶ˆì‘ì°°(+50,000ì›)
          </label>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <button id="btnLockPart" class="btn bg-orange-500 hover:bg-orange-600 text-white rounded px-4 py-2 text-sm">ì‘ì°° í™•ì •</button>
          <button id="btnResyncPart" class="icon-btn" aria-label="ìƒˆë¡œê³ ì¹¨" title="ìƒˆë¡œê³ ì¹¨">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v6h-6"/></svg>
          </button>
          <span id="partStatus" class="badge bg-slate-100">ë¯¸í™•ì •</span>
        </div>
        <p class="text-xs text-slate-500">â€» ë¶ˆì‘ì°° í™•ì • ì‹œ ì¦‰ì‹œ 50,000ì› ì§€ê¸‰</p>
        <p id="chooseHint" class="text-xs text-orange-600 hidden">â€» ë°©ì¥ì´ ì¹´ë“œë¥¼ ì„ íƒí•´ì•¼ ì‘ì°° í™•ì • ê°€ëŠ¥</p>
      </div>

      <!-- 2ë‹¨ê³„: ì…ì°° -->
      <div id="phaseBid" class="hidden space-y-3">
        <h3 class="font-semibold text-orange-700">2) ë¹„ê³µê°œ ì…ì°°</h3>
        <div class="text-sm flex items-center gap-2">
          ì´ë²ˆ ì¹´ë“œ: <b id="currentItemBid">-</b>
          <img id="imgCurrentBid" alt="" class="item-img" style="display:none;">
        </div>

        <div id="bidDisabled" class="hidden text-sm text-slate-500">ì´ë²ˆ ë¼ìš´ë“œ ë¶ˆì‘ì°°í•˜ì—¬ ì…ì°° ë¶ˆê°€</div>

        <div id="bidBox" class="hidden">
          <div class="flex items-center gap-2 mb-2 flex-wrap">
            <button data-step="-5" class="shrink-0 px-3 py-2 rounded bg-orange-200 text-xs">-5ë§Œ</button>
            <button data-step="-1" class="shrink-0 px-3 py-2 rounded bg-orange-200 text-xs">-1ë§Œ</button>
            <input id="bidInput" inputmode="numeric" class="mono w-28 border border-orange-300 rounded px-3 py-2 text-right" placeholder="0" />
            <button data-step="1"  class="shrink-0 px-3 py-2 rounded bg-orange-200 text-xs">+1ë§Œ</button>
            <button data-step="5"  class="shrink-0 px-3 py-2 rounded bg-orange-200 text-xs">+5ë§Œ</button>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="btnConfirmBid" class="btn bg-orange-500 hover:bg-orange-600 text-white rounded px-4 py-2 text-sm">ì…ì°° í™•ì •</button>
            <button id="btnCancelBid" class="btn bg-slate-300 hover:bg-slate-400 rounded px-4 py-2 text-sm">ì…ì°° ì·¨ì†Œ</button>
            <span id="bidStatus" class="badge bg-slate-100">ëŒ€ê¸°ì¤‘</span>
          </div>
          <p class="text-xs text-slate-500">â€» ì…ì°°ì•¡ì€ ë¹„ê³µê°œ</p>
        </div>
      </div>

      <hr class="my-4 border-orange-200">

      <h3 class="font-semibold mb-2 text-orange-700">ë‚´ ì†Œì§€í’ˆ</h3>
      <ul id="myItems" class="mt-2 space-y-2 text-sm"></ul>

      <div class="mt-4 p-3 rounded-lg border border-orange-200 bg-orange-50 text-sm">
        <div class="font-semibold mb-1 text-orange-700">ìŠ¹ë¦¬ ì¡°ê±´</div>
        <ul class="list-disc ml-5 space-y-1 text-slate-700">
          <li>ëª¨ë‘ ê°™ì€ ì¹´ë“œ <b>3ê°œ</b></li>
          <li>ëª¨ë‘ ë‹¤ë¥¸ ì¹´ë“œ <b>4ê°œ</b></li>
          <li>ì¹´ë“œ <b>5ê°œ</b></li>
        </ul>
        <p class="text-xs text-red-600 mt-2">* ì¡°ì»¤ëŠ” ì–´ë–¤ ì¹´ë“œë¡œë„ ëŒ€ì²´ ê°€ëŠ¥!</p>
      </div>
    </section>

    <!-- ê³µê°œ ì •ë³´ -->
    <section id="panelPublic" class="card p-4 md:p-6 lg:col-span-7 xl:col-span-5">
      <h2 class="font-semibold mb-3 text-orange-700">ë¼ìš´ë“œ ì •ë³´</h2>
      <div class="text-sm text-slate-600 mb-2 flex flex-wrap items-center gap-2">
        <span>ë‹¨ê³„: <b id="phaseText">-</b></span>
        <span>ì´ë²ˆ ì¹´ë“œ: <b id="currentItem">-</b></span>
        <img id="imgCurrentPublic" alt="" class="item-img" style="display:none;">
      </div>

      <div id="revealBox" class="hidden mt-4 p-3 rounded-lg bg-orange-50 border border-orange-200">
        <h3 class="font-semibold mb-2 text-orange-700">ì´ë²ˆ ë¼ìš´ë“œ ì‘ì°°ì</h3>
        <ul id="participantList" class="space-y-1 text-sm"></ul>
        <p class="text-xs text-slate-500 mt-2">â€» ì…ì°°ì•¡ì€ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
      </div>

      <h3 class="font-semibold mt-6 mb-2 text-orange-700">ë¼ìš´ë“œ ë¡œê·¸</h3>
      <ul id="roundLog" class="space-y-2 text-xs text-slate-700 max-h-40 overflow-y-auto"></ul>

      <div id="detailLogWrap" class="hidden">
        <h3 class="font-semibold mt-6 mb-2 text-orange-700">ê²Œì„ ê¸°ë¡(ìƒì„¸)</h3>
        <ul id="detailLog" class="space-y-2 text-xs text-slate-700 max-h-60 overflow-y-auto"></ul>
      </div>

      <div id="playersWrap" class="hidden">
        <h3 class="font-semibold mt-6 mb-2 text-orange-700">ìµœì¢… í”Œë ˆì´ì–´ í˜„í™©</h3>
        <ul id="players" class="space-y-2 text-sm"></ul>
      </div>
    </section>

  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-lg z-40 flex items-center gap-2 text-sm">
    <img id="toastImg" width="24" height="24" style="display:none" alt="" class="rounded">
    <span id="toastMsg"></span>
  </div>
</div>

<!-- ëª¨ë°”ì¼ í•˜ë‹¨ ì…ì°° ë°” -->
<div id="mobileBidBar" class="md:hidden fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t border-orange-200 shadow-lg z-50 hidden">
  <div class="max-w-7xl mx-auto px-3 py-2">
    <div class="text-xs text-slate-600 mb-1 flex items-center gap-2">
      ì´ë²ˆ ì¹´ë“œ: <b id="currentItemMobile">-</b>
      <img id="imgCurrentMobile" alt="" class="w-6 h-6 rounded object-cover border border-orange-300" style="display:none;">
    </div>
    <div class="flex items-center gap-1 mt-1">
      <button data-step="-5" class="flex-1 py-2 rounded bg-orange-200 text-xs">-5ë§Œ</button>
      <button data-step="-1" class="flex-1 py-2 rounded bg-orange-200 text-xs">-1ë§Œ</button>
      <input id="bidInputMobile" inputmode="numeric" class="mono w-24 flex-none border border-orange-300 rounded px-2 py-2 text-right text-sm" placeholder="0" />
      <button data-step="1"  class="flex-1 py-2 rounded bg-orange-200 text-xs">+1ë§Œ</button>
      <button data-step="5"  class="flex-1 py-2 rounded bg-orange-200 text-xs">+5ë§Œ</button>
    </div>
    <div class="flex items-center gap-2 mt-2">
      <button id="btnConfirmBidMobile" class="flex-1 py-2 rounded bg-orange-500 text-white text-sm font-semibold">í™•ì •</button>
      <button id="btnCancelBidMobile"  class="flex-1 py-2 rounded bg-slate-300 text-sm">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script type="module">
  const $=s=>document.querySelector(s);
  const fmt=n=>Number(n||0).toLocaleString("ko-KR");
  const show=(sel,yes)=>$(sel)?.classList.toggle("hidden",!yes);
  const toast=(msg,img)=>{
    $("#toastMsg").textContent=msg;
    const im=$("#toastImg");
    if(img){im.src=img; im.style.display="";}else{im.style.display="none";}
    $("#toast").classList.remove("hidden");
    setTimeout(()=>$("#toast").classList.add("hidden"), 2500);
  };

  const params=new URL(location.href).searchParams;
  const roomId=(params.get("room")||"");
  const myName=(params.get("name")||"").trim();

  $("#roomId").textContent=roomId||"â€”";
  $("#you").textContent=myName||"â€”";
  $("#myName").textContent=myName||"â€”";

  if (!roomId || !myName) {
    alert("ë°© ì •ë³´ ë˜ëŠ” ë‹‰ë„¤ì„ì´ ì—†ìŠµë‹ˆë‹¤.");
    location.href = "room.html";
    throw new Error("Invalid room or name");
  }

  await window.firebaseReady;
  const { getFirestore, doc, getDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp,
          getAuth, signInAnonymously, runTransaction } = window.__fb;

  const db=getFirestore(), auth=getAuth();
  try{
    if(!auth.currentUser) await signInAnonymously(auth);
    $("#badge").textContent="ì—°ê²°ë¨";
    $("#badge").className="badge bg-orange-500 text-white";
  }catch(e){
    $("#badge").textContent="ì—°ê²° ì‹¤íŒ¨";
    $("#badge").className="badge bg-rose-600 text-white";
  }

  const ref=doc(db,"wewin_rooms",roomId);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const STALE_MS = 60 * 60 * 1000;
  const NO_BID_BONUS = 50000;

  // ì¹´ë“œ ëª©ë¡ (ì¡°ì»¤ ì œì™¸ ê¸°ë³¸ 4ê°œ)
  const BASE_ITEMS = ["ë‘ ì •ì¹˜ ì„¸ë ¥", "ì¤€ì˜ì´ì˜ ë°”ë‚˜ë‚˜", "í‚¹ ì‹ ì›… êµìˆ˜ë‹˜", "ë³´ê¸ˆì´ì˜ í´ë¡œë²„ë¥¼ ë“  í•˜ì˜ì´"];
  const JOKER = "ì¡°ì»¤ ì´ì„±ë¡œ";
  const JOKER_CHANCE = 0.15; // 15% í™•ë¥ ë¡œ ì¡°ì»¤ ë“±ì¥

  // ì´ë¯¸ì§€ ë§¤í•‘
  const ITEM_IMG = {
    "ë‘ ì •ì¹˜ ì„¸ë ¥": "politics.jpeg",
    "ì¤€ì˜ì´ì˜ ë°”ë‚˜ë‚˜": "banana.png",
    "í‚¹ ì‹ ì›… êµìˆ˜ë‹˜": "king.png",
    "ë³´ê¸ˆì´ì˜ í´ë¡œë²„ë¥¼ ë“  í•˜ì˜ì´": "clover.png",
    "ì¡°ì»¤ ì´ì„±ë¡œ": "joker.jpeg"
  };
  const RESULT_IMG = { success:"success.jpeg", fail:"fail.svg" };

  function setItemImg(el, item){
    if(!el) return;
    const file = ITEM_IMG[item||""];
    if(file){
      el.src = file;
      el.style.display = "";
      el.alt = item || "ì¹´ë“œ";
      el.classList.toggle("joker-border", item === JOKER);
    }else{
      el.style.display = "none";
    }
  }
  function renderItemImages(item){
    setItemImg($("#imgCurrentMe"), item);
    setItemImg($("#imgCurrentBid"), item);
    setItemImg($("#imgCurrentPublic"), item);
    setItemImg($("#imgCurrentMobile"), item);
  }

  // ëœë¤ ì¹´ë“œ ì„ íƒ (ì¡°ì»¤ 10% í™•ë¥ )
  function randItem(){
    if(Math.random() < JOKER_CHANCE) return JOKER;
    return BASE_ITEMS[Math.floor(Math.random() * BASE_ITEMS.length)];
  }

  const isStale = (d)=>{
    try{ const ts=d?.updatedAt?.toMillis?.(); return ts ? (Date.now()-ts>STALE_MS) : false; }catch{return false;}
  };

  function guessHost(r){
    const a=(r?.hostName||"").trim().toLowerCase();
    const b=(myName||"").trim().toLowerCase();
    const p1=(r?.players||[])[0];
    const p1n=(p1?.name||"").trim().toLowerCase();
    return (a&&a===b)||(p1n&&p1n===b);
  }

  // ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬ (ì¡°ì»¤ = ì™€ì¼ë“œì¹´ë“œ)
  function checkWin(items=[]){
    if(!Array.isArray(items)) return "";
    const t = items.length;
    if(t < 3) return "";

    // ì¡°ì»¤ ê°œìˆ˜
    const jokers = items.filter(x => x === JOKER).length;
    const nonJokers = items.filter(x => x !== JOKER);

    // 5ê°œ ì´ìƒì´ë©´ ë¬´ì¡°ê±´ ìŠ¹ë¦¬
    if(t >= 5) return "any5";

    // ê°™ì€ ì¹´ë“œ 3ê°œ ì²´í¬ (ì¡°ì»¤ í¬í•¨)
    // ì¡°ì»¤ëŠ” ê°€ì¥ ë§ì€ ì¹´ë“œì™€ ê°™ì€ ê²ƒìœ¼ë¡œ ì·¨ê¸‰
    const counts = {};
    nonJokers.forEach(it => counts[it] = (counts[it]||0) + 1);
    const maxCount = Object.values(counts).length > 0 ? Math.max(...Object.values(counts)) : 0;
    // ì¡°ì»¤ë§Œ 3ê°œ ì´ìƒì´ê±°ë‚˜, íŠ¹ì • ì¹´ë“œ + ì¡°ì»¤ë¡œ 3ê°œ ì´ìƒ
    if(maxCount + jokers >= 3) return "same3";

    // ë‹¤ë¥¸ ì¹´ë“œ 4ê°œ ì²´í¬ (tê°€ 4 ì´ìƒì¼ ë•Œë§Œ)
    if(t >= 4) {
      const uniqueNonJoker = new Set(nonJokers).size;
      // ì¡°ì»¤ëŠ” ì—†ëŠ” ì¹´ë“œ ì¢…ë¥˜ë¥¼ ëŒ€ì²´ (ìµœëŒ€ 4ì¢…ë¥˜ê¹Œì§€)
      const possibleUnique = Math.min(uniqueNonJoker + jokers, BASE_ITEMS.length);
      if(possibleUnique >= 4) return "diff4";
    }

    return "";
  }

  let isHost=false, currentPlayers=[], currentMe=null;
  let lastSeenResultRound=0, singleRevealTimerSet=false;
  let endedLocally=false, deletedOnce=false;

  // ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€
  let isProcessing = false;
  function withLock(fn) {
    return async (...args) => {
      if (isProcessing) return;
      isProcessing = true;
      try {
        await fn(...args);
      } catch (e) {
        console.error(e);
        toast(`ì˜¤ë¥˜: ${e.message || e}`);
      } finally {
        setTimeout(() => { isProcessing = false; }, 500);
      }
    };
  }

  // ì…ì°°(1ë§Œ ë‹¨ìœ„)
  let bidStep=10000, stagedBid=0;
  const parseMoney=s=>Number((s||"0").replace(/[^\d]/g,""))||0;
  const snapToStep=n=>Math.floor(Number(n||0)/bidStep)*bidStep;
  const bidInput=$("#bidInput"), bidInputMobile=$("#bidInputMobile");

  function syncBidInputs(){
    const v=snapToStep(stagedBid);
    if(bidInput) bidInput.value=v.toLocaleString("ko-KR");
    if(bidInputMobile) bidInputMobile.value=v.toLocaleString("ko-KR");
  }
  function clampToAvail(a){
    stagedBid=Math.max(0, Math.min(snapToStep(stagedBid), a));
    syncBidInputs();
  }
  function bindStepButtons(){
    document.querySelectorAll("[data-step]").forEach(btn=>{
      if(btn._bound) return;
      btn._bound=true;
      btn.addEventListener("click", ()=>{
        const factor=Number(btn.getAttribute("data-step"));
        const delta=factor*bidStep;
        const avail=(currentMe?.balance||0)+(currentMe?.hold||0);
        stagedBid=stagedBid+delta;
        clampToAvail(avail);
      });
    });
  }
  syncBidInputs();
  bindStepButtons();
  bidInput?.addEventListener("input", ()=>{ stagedBid=parseMoney(bidInput.value); syncBidInputs(); });
  bidInput?.addEventListener("blur", ()=>{ const a=(currentMe?.balance||0)+(currentMe?.hold||0); clampToAvail(a); });
  bidInputMobile?.addEventListener("input", ()=>{ stagedBid=parseMoney(bidInputMobile.value); syncBidInputs(); });
  bidInputMobile?.addEventListener("blur", ()=>{ const a=(currentMe?.balance||0)+(currentMe?.hold||0); clampToAvail(a); });

  function endUI(msg, winners=[]){
    if (winners.length){
      $("#endMsg").textContent = `ê²Œì„ ì¢…ë£Œ! ìš°ìŠ¹: ${winners.join(", ")}`;
    } else if (!endedLocally) {
      $("#endMsg").textContent = msg;
    }
    $("#endedBox").classList.remove("hidden");
    ["btnConfirmBid","btnCancelBid","btnConfirmBidMobile","btnCancelBidMobile","btnLockPart","btnResyncPart"]
      .forEach(id=>{ const el=$("#"+id); if(el) el.setAttribute("disabled","true"); });
    show("#mobileBidBar", false);
  }

  async function ensurePhaseDefault(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(!r.phase){ tx.update(ref,{phase:"choose",updatedAt:serverTimestamp()}); }
      });
    }catch(e){ console.warn("ensurePhaseDefault:", e); }
  }

  async function ensureRandomItemIfEmpty(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if((r.phase||"choose")==="choose" && !r.currentItem){
          tx.update(ref,{currentItem:randItem(),updatedAt:serverTimestamp()});
        }
      });
    }catch(e){ console.warn("ensureRandomItemIfEmpty:", e); }
  }

  async function afterAllLockedAdvance(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if((r.phase||"choose")!=="choose") return;
        const players=(r.players||[]);
        if(players.length===0) return;

        const item=(r.currentItem||"").trim();

        const allLocked=players.every(p=>p.readyPart===true || p.ready===true);
        if(!allLocked) return;

        const parts=players
          .filter(p=>p.willParticipate===true || (p.willParticipate===undefined && p.committed===true))
          .map(p=>p.name);

        const chosenItem = item || randItem();

        if(parts.length===0){
          const reset=players.map(p=>({...p,hold:0,bid:0,committed:false,readyPart:false,readyBid:false,willParticipate:null}));
          const logs=[...(r.roundLogs||[])];
          logs.push({round:(r.round||0)+1, item:chosenItem, participants:[], winners:[]});
          tx.update(ref,{
            players:reset,
            round:(r.round||0)+1,
            currentItem:"",
            participants:[],
            participantsBackup:[],
            lastItem:"",
            lastWinners:[],
            resultRound:(r.round||0)+1,
            phase:"choose",
            roundLogs:logs.slice(-30),
            updatedAt:serverTimestamp()
          });
          return;
        }

        if(parts.length===1){
          tx.update(ref,{
            participants:parts,
            participantsBackup:parts,
            currentItem:chosenItem,
            lastItem:chosenItem,
            phase:"reveal_single",
            revealRound:(r.round||0)+1,
            revealAt:serverTimestamp(),
            updatedAt:serverTimestamp()
          });
          return;
        }

        tx.update(ref,{
          participants:parts,
          participantsBackup:parts,
          currentItem:chosenItem,
          lastItem:chosenItem,
          phase:"bid",
          updatedAt:serverTimestamp()
        });
      });
    }catch(e){ console.warn("afterAllLockedAdvance:", e); }
  }

  async function attemptSettleFromBid(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="bid") return;

        let players=(r.players||[]).map(p=>({...p}));
        const partNames=(r.participants||[]);
        const participants=players.filter(p=>partNames.includes(p.name));
        const readyAll = participants.length===0 ? true : participants.every(p=>p.readyBid===true || p.committed===true);
        if(!readyAll) return;

        const item = (r.currentItem || r.lastItem || "").trim();
        if (!item) return;

        const bids = {};
        participants.forEach(p => { bids[p.name] = Number(p.hold||0); });

        let winners=[]; let winningBid=0;

        if(participants.length){
          const holds = participants.map(p=>Number(p.hold||0));
          const maxHold = Math.max(0, ...holds);
          const allZero = holds.every(h=>h===0);

          if(allZero){
            // ëª¨ë‘ 0ì› ì…ì°° ì‹œ ì•„ë¬´ë„ ì¹´ë“œë¥¼ ë°›ì§€ ëª»í•¨
            winners = [];
            winningBid = 0;
            players = players.map(p=>({
              ...p,
              hold:0,bid:0,
              committed:false,readyPart:false,readyBid:false,willParticipate:null
            }));
          }else if(maxHold>0){
            winners=participants.filter(p=>Number(p.hold||0)===maxHold).map(p=>p.name);
            winningBid = maxHold;
            players=players.map(p=>{
              const isPart=partNames.includes(p.name);
              let balance=Number(p.balance||0), hold=Number(p.hold||0);
              const items=[...(p.items||[])];
              if(isPart){
                if(winners.includes(p.name)) items.push(item);
                else balance+=hold;
              }
              return {
                ...p,
                balance,
                hold:0,bid:0,
                committed:false,readyPart:false,readyBid:false,willParticipate:null,
                items
              };
            });
          }else{
            players=players.map(p=>({
              ...p,
              hold:0,bid:0,
              committed:false,readyPart:false,readyBid:false,willParticipate:null
            }));
          }
        }else{
          players=players.map(p=>({
            ...p,
            hold:0,bid:0,
            committed:false,readyPart:false,readyBid:false,willParticipate:null
          }));
        }

        const logs=[...(r.roundLogs||[])];
        logs.push({round:(r.round||0)+1, item, participants:partNames, winners});

        const detail = {
          round: (r.round||0)+1,
          item,
          participants: partNames,
          bids,
          winners,
          winningBid,
          skipped: (r.players||[]).filter(p=>!partNames.includes(p.name)).map(p=>p.name),
          mode: "web",
          ts: Date.now()
        };
        const detailed = [...(r.roundLogsDetailed||[]), detail].slice(-200);

        tx.update(ref,{
          players,
          round:(r.round||0)+1,
          currentItem:"",
          participants:[],
          lastWinners:winners,
          lastItem:item,
          resultRound:(r.round||0)+1,
          phase:"choose",
          roundLogs:logs.slice(-30),
          roundLogsDetailed: detailed,
          updatedAt:serverTimestamp()
        });
      });
    }catch(e){ console.warn("attemptSettleFromBid:", e); }
  }

  async function settleAfterSingleReveal(){
    try{
      await runTransaction(db, async tx=>{
        const s=await tx.get(ref); if(!s.exists()) return;
        const r=s.data();
        if(r.phase!=="reveal_single") return;

        let players=(r.players||[]).map(p=>({...p}));
        const partNames=(r.participants||[]);
        if(partNames.length!==1) return;

        const item = (r.currentItem || r.lastItem || "").trim();
        if (!item) return;

        const only=partNames[0];
        const winners=[only];

        const bids = {};
        bids[only] = Number((players.find(p=>p.name===only)||{}).hold||0) || 0;
        const winningBid = 0;

        players=players.map(p=>{
          if(p.name===only){
            const refund=Number(p.hold||0);
            return {
              ...p,
              balance:Number(p.balance||0)+refund,
              hold:0,bid:0,
              committed:false,readyPart:false,readyBid:false,willParticipate:null,
              items:[...(p.items||[]),item]
            };
          }
          return {
            ...p,
            hold:0,bid:0,
            committed:false,readyPart:false,readyBid:false,willParticipate:null
          };
        });

        const logs=[...(r.roundLogs||[])];
        logs.push({round:(r.round||0)+1, item, participants:partNames, winners});

        const detail = {
          round:(r.round||0)+1,
          item,
          participants: partNames,
          bids,
          winners,
          winningBid,
          skipped: (r.players||[]).filter(p=>!partNames.includes(p.name)).map(p=>p.name),
          mode: "web",
          ts: Date.now()
        };
        const detailed = [...(r.roundLogsDetailed||[]), detail].slice(-200);

        tx.update(ref,{
          players,
          round:(r.round||0)+1,
          currentItem:"",
          participants:[],
          lastWinners:winners,
          lastItem:item,
          resultRound:(r.round||0)+1,
          phase:"choose",
          roundLogs:logs.slice(-30),
          roundLogsDetailed: detailed,
          updatedAt:serverTimestamp()
        });
      });
    }catch(e){ console.warn("settleAfterSingleReveal:", e); }
  }

  await ensurePhaseDefault();

  onSnapshot(ref, async (s)=>{
    if(!s.exists()){
      endUI("ë°©ì´ ì¢…ë£Œ(ì‚­ì œ)ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }
    const d=s.data();
    window.__lastRoomSnap = d;

    if(!d.gameOver && isStale(d)){
      try{ await deleteDoc(ref); }catch(_){}
      return;
    }

    $("#round").textContent=d.round??0;
    const phaseLabel = d.phase==="choose" ? "ì‘ì°° ì„ íƒ" :
                       d.phase==="bid" ? "ë¹„ê³µê°œ ì…ì°°" :
                       d.phase==="reveal_single" ? "ë‹¨ë… ì‘ì°°" : "-";
    $("#phaseText").textContent = phaseLabel;

    const itemName = d.currentItem || "-";
    const isJoker = itemName === JOKER;
    $("#currentItem").textContent = itemName;
    $("#currentItemMe").textContent = itemName;
    $("#currentItemBid").textContent= itemName;
    $("#currentItemMobile").textContent = itemName;
    renderItemImages(d.currentItem || "");

    isHost=guessHost(d);
    $("#role").textContent=isHost?"host":"guest";
    show("#hostEndBox", isHost && !d.gameOver);

    const players = Array.isArray(d.players)? d.players : [];
    const me = players.find(p=>p.name===myName) || null;
    currentPlayers = players;
    currentMe = me;

    $("#myBalance").textContent = fmt(me?.balance||0);
    $("#myHold").textContent = fmt(me?.hold||0);

    // ì†Œì§€í’ˆ ë Œë”ë§
    const myItems=Array.isArray(me?.items)? me.items : [];
    const ulItems=$("#myItems");
    ulItems.innerHTML="";
    myItems.forEach((it,i)=>{
      const li=document.createElement("li");
      const isJ = it === JOKER;
      li.className="flex items-center gap-2 border rounded px-3 py-2 " + (isJ ? "border-red-400 bg-red-50" : "border-orange-200 bg-orange-50");
      const imgFile = ITEM_IMG[it] || "";
      li.innerHTML = `
        ${imgFile ? `<img src="${imgFile}" alt="${it}" class="w-8 h-8 rounded object-cover border ${isJ?'border-red-400':'border-orange-300'}">` : ''}
        <span class="${isJ?'text-red-600 font-bold':''}">${i+1}. ${it}</span>
      `;
      ulItems.appendChild(li);
    });

    // ìŠ¹ë¦¬ ì²´í¬ (ëª¨ë“  í”Œë ˆì´ì–´ í™•ì¸)
    const allWinners = players.filter(p => checkWin(p.items||[]) !== "");
    if(allWinners.length > 0 && !d.gameOver){
      try{
        await runTransaction(db, async tx=>{
          const s2=await tx.get(ref); if(!s2.exists()) return;
          const r=s2.data();
          if(r.gameOver) return; // ì´ë¯¸ ì¢…ë£Œëœ ê²½ìš° ìŠ¤í‚µ
          const winners = (r.players||[]).filter(p=>checkWin(p.items||[])!=="").map(p=>p.name);
          const firstWinner = winners[0] || "";
          const winReason = firstWinner ? checkWin((r.players||[]).find(p=>p.name===firstWinner)?.items||[]) : "";
          tx.update(ref,{
            gameOver:true,
            endedAt: serverTimestamp(),
            finalWinners: winners,
            victoryReason: winReason,
            updatedAt: serverTimestamp()
          });
        });
      }catch(_){}
    }

    // í”Œë ˆì´ì–´ í˜„í™© (ê²Œì„ ì¢…ë£Œ í›„ì—ë§Œ í‘œì‹œ)
    show("#playersWrap", !!d.gameOver);
    if(d.gameOver){
      const ul=$("#players");
      ul.innerHTML="";
      players.forEach((p,i)=>{
        const li=document.createElement("li");
        li.className="flex items-center justify-between border border-orange-200 rounded px-3 py-2 bg-white";
        const pItems = p.items||[];
        li.innerHTML=`<div class="flex items-center gap-2">
          <span>${i+1}. ${p.name}</span>
          <span class="badge ${checkWin(pItems)?"bg-emerald-100":"bg-slate-100"}">${pItems.length}ì¥</span>
        </div>
        <span class="text-xs text-slate-500">${fmt(p.balance||0)}ì›</span>`;
        ul.appendChild(li);
      });
    }

    // ì‘ì°°ì ê³µê°œ
    if(Array.isArray(d.participants) && d.participants.length>0){
      show("#revealBox", true);
      const pu=$("#participantList");
      pu.innerHTML="";
      d.participants.forEach((nm,idx)=>{
        const li=document.createElement("li");
        li.className="border border-orange-200 rounded px-3 py-2 bg-white";
        li.textContent = `${idx+1}. ${nm}`;
        pu.appendChild(li);
      });
    }else{
      show("#revealBox", false);
    }

    // ë¼ìš´ë“œ ë¡œê·¸ (ì‘ì°°ìë§Œ í‘œì‹œ, ë‚™ì°°ìëŠ” ë¹„ê³µê°œ)
    const logUl = $("#roundLog");
    logUl.innerHTML="";
    (d.roundLogs||[]).slice().reverse().slice(0,10).forEach(entry=>{
      const li=document.createElement("li");
      const parts = (entry.participants||[]).length ? entry.participants.join(", ") : "ì—†ìŒ";
      const isJ = entry.item === JOKER;
      li.className="border rounded px-3 py-2 " + (isJ ? "border-red-300 bg-red-50" : "border-orange-200 bg-orange-50");
      li.innerHTML = `<div class="flex items-center justify-between">
        <div>R${entry.round} Â· <b class="${isJ?'text-red-600':''}">${entry.item||"-"}</b></div>
        <div class="text-slate-500">ì‘ì°°: ${parts}</div>
      </div>`;
      logUl.appendChild(li);
    });

    // ìƒì„¸ ë¡œê·¸ (ì¢…ë£Œ í›„)
    show("#detailLogWrap", !!d.gameOver);
    if(d.gameOver){
      const detUl = $("#detailLog");
      detUl.innerHTML="";
      const dlogs = d.roundLogsDetailed || [];
      dlogs.slice().reverse().forEach(entry=>{
        const li=document.createElement("li");
        const bidsTxt = Object.keys(entry.bids||{}).length
          ? Object.entries(entry.bids).map(([nm,amt])=>`${nm}:${fmt(amt)}ì›`).join(", ")
          : "â€”";
        const skips = (entry.skipped||[]).length ? entry.skipped.join(", ") : "ì—†ìŒ";
        const isJ = entry.item === JOKER;
        li.className="border rounded px-3 py-2 " + (isJ ? "border-red-200 bg-red-50" : "bg-white");
        const winnersTxt = (entry.winners||[]).length ? entry.winners.join(", ") : "ì—†ìŒ";
        li.innerHTML = `
          <div class="flex items-center justify-between">
            <div>R${entry.round} Â· <b class="${isJ?'text-red-600':''}">${entry.item||"-"}</b></div>
            <div class="text-slate-500">ë‚™ì°°ê°€: ${fmt(entry.winningBid||0)}ì›</div>
          </div>
          <div class="mt-1 text-slate-700">ì‘ì°°ì•¡: ${bidsTxt}</div>
          <div class="mt-1 font-bold ${winnersTxt==="ì—†ìŒ"?"text-slate-400":"text-emerald-600"}">ğŸ† ë‚™ì°°: ${winnersTxt}</div>
          <div class="mt-1 text-slate-400 text-xs">ë¶ˆì‘ì°°: ${skips}</div>
        `;
        detUl.appendChild(li);
      });

      const winnersArr = d.finalWinners || [];
      endedLocally = true;
      endUI("", winnersArr);

      if (!deletedOnce) {
        deletedOnce = true;
        try{ await deleteDoc(ref); }catch(_){}
      }
    }

    // ë‹¨ê³„ë³„ UI
    if(d.phase==="choose" || d.phase===undefined){
      show("#phaseChoose", true);
      show("#phaseBid", false);
      show("#mobileBidBar", false);
      show("#chooseHint", false);

      if(!d.currentItem) await ensureRandomItemIfEmpty();

      const partRadios=[...document.querySelectorAll('input[name="part"]')];
      const partVal = me?.willParticipate===true ? "yes" : me?.willParticipate===false? "no" : null;
      partRadios.forEach(r=>{ r.checked=(r.value===partVal); r.disabled=((me?.readyPart===true)||(me?.ready===true)); });

      $("#btnLockPart").disabled = ((me?.readyPart===true)||(me?.ready===true)) || !(d.currentItem);
      $("#partStatus").textContent = ((me?.readyPart===true)||(me?.ready===true))
        ? (me?.willParticipate ? "ì‘ì°° ì°¸ì—¬ í™•ì •" : "ë¶ˆì‘ì°° í™•ì •(+5ë§Œ)") : "ë¯¸í™•ì •";

      await afterAllLockedAdvance();
    }
    else if(d.phase==="reveal_single"){
      show("#phaseChoose", true);
      show("#phaseBid", false);
      show("#mobileBidBar", false);
      if(!singleRevealTimerSet){
        singleRevealTimerSet=true;
        setTimeout(async()=>{
          singleRevealTimerSet=false;
          await settleAfterSingleReveal();
        }, 1000);
      }
    }
    else if(d.phase==="bid"){
      const isParticipant = me?.willParticipate===true || (Array.isArray(d.participants)&&d.participants.includes(myName));
      show("#phaseChoose", false);
      show("#phaseBid", true);
      show("#bidBox", isParticipant);
      show("#bidDisabled", !isParticipant);
      show("#mobileBidBar", isParticipant);
      const isReadyBid = (me?.readyBid===true)||(me?.committed===true);
      $("#bidStatus").textContent = isReadyBid ? "ì…ì°° í™•ì •ë¨" : "ëŒ€ê¸°ì¤‘";
      const avail=(me?.balance||0)+(me?.hold||0);
      clampToAvail(avail);

      await attemptSettleFromBid();
    }

    bindStepButtons();
  });

  // ì‘ì°° í™•ì •
  $("#btnLockPart").addEventListener("click", withLock(async ()=>{
    const cur=document.querySelector('input[name="part"]:checked');
    if(!cur){ toast("ì‘ì°°/ë¶ˆì‘ì°°ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    const choice = cur.value==="yes";

    const snap=await getDoc(ref);
    if(!snap.exists()) { toast("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    const r=snap.data();
    const players=(r.players||[]).map(p=>({...p}));
    const me=players.find(p=>p.name===myName);
    if(!me) { toast("í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    if(me.readyPart===true || me.ready===true){ toast("ì´ë¯¸ ì‘ì°° í™•ì •í–ˆìŠµë‹ˆë‹¤."); return; }
    if(!r.currentItem){ toast("ì¹´ë“œê°€ ì•„ì§ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }

    me.willParticipate = choice;
    me.readyPart = true;
    delete me.ready;
    if(choice===false){
      me.balance = Number(me.balance||0) + NO_BID_BONUS;
    }
    await updateDoc(ref,{ players, updatedAt:serverTimestamp() });
    toast(choice ? "ì‘ì°° ì°¸ì—¬ë¥¼ í™•ì •í–ˆìŠµë‹ˆë‹¤." : `ë¶ˆì‘ì°°(+${fmt(NO_BID_BONUS)}ì›)ì„ í™•ì •í–ˆìŠµë‹ˆë‹¤.`);
  }));

  // ì‘ì°° ìƒˆë¡œê³ ì¹¨
  $("#btnResyncPart").addEventListener("click", async ()=>{
    try{
      const s=await getDoc(ref);
      if(!s.exists()) return;
      const d=s.data();
      const me=(d.players||[]).find(p=>p.name===myName) || {};
      const canEdit = !(me.readyPart===true || me.ready===true);
      [...document.querySelectorAll('input[name="part"]')].forEach(r=> r.disabled = !canEdit);
      $("#btnLockPart").disabled = !canEdit || !(d.currentItem);
      $("#partStatus").textContent = me.readyPart||me.ready ? (me.willParticipate ? "ì‘ì°° ì°¸ì—¬ í™•ì •" : "ë¶ˆì‘ì°° í™•ì •(+5ë§Œ)") : "ë¯¸í™•ì •";
      toast("ìƒíƒœë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆì–´ìš”.");
    }catch(e){ alert(`ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${e.message||e}`); }
  });

  // ì…ì°° í™•ì •/ì·¨ì†Œ
  const doConfirmBid = withLock(async ()=>{
    const snap=await getDoc(ref);
    if(!snap.exists()) { toast("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    const r=snap.data();
    if(r.phase!=="bid"){ toast("ì•„ì§ ì…ì°° ë‹¨ê³„ê°€ ì•„ë‹™ë‹ˆë‹¤."); return; }
    const players=(r.players||[]).map(p=>({...p}));
    const me=players.find(p=>p.name===myName);
    if(!me) { toast("í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    if(me.readyBid===true || me.committed===true) { toast("ì´ë¯¸ ì…ì°°ì„ í™•ì •í–ˆìŠµë‹ˆë‹¤."); return; }
    const isPart = (me.willParticipate===true) || (Array.isArray(r.participants)&&r.participants.includes(myName));
    if(!isPart){ toast("ì´ë²ˆ ë¼ìš´ë“œëŠ” ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    const avail=Number(me.balance||0)+Number(me.hold||0);
    let val = snapToStep(stagedBid);
    val = Math.max(0, Math.min(val, avail));
    me.hold=val;
    me.bid=val;
    me.balance=avail - val;
    me.committed=true;
    me.readyBid=true;
    await updateDoc(ref,{ players, updatedAt:serverTimestamp() });
    toast(`ì…ì°°ì„ í™•ì •í–ˆìŠµë‹ˆë‹¤. (${fmt(val)}ì›)`);
  });

  const doCancelBid = withLock(async ()=>{
    const snap=await getDoc(ref);
    if(!snap.exists()) { toast("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    const r=snap.data();
    if(r.phase!=="bid"){ toast("ì•„ì§ ì…ì°° ë‹¨ê³„ê°€ ì•„ë‹™ë‹ˆë‹¤."); return; }
    const players=(r.players||[]).map(p=>({...p}));
    const me=players.find(p=>p.name===myName);
    if(!me) { toast("í”Œë ˆì´ì–´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    if(me.readyBid===true || me.committed===true) { toast("ì´ë¯¸ ì…ì°°ì„ í™•ì •í–ˆìŠµë‹ˆë‹¤."); return; }
    const isPart = (me.willParticipate===true) || (Array.isArray(r.participants)&&r.participants.includes(myName));
    if(!isPart){ toast("ì´ë²ˆ ë¼ìš´ë“œëŠ” ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    const refund=Number(me.hold||0);
    me.balance=Number(me.balance||0)+refund;
    me.hold=0;
    me.bid=0;
    me.committed=false;
    me.readyBid=true;
    await updateDoc(ref,{ players, updatedAt:serverTimestamp() });
    toast("ì…ì°°ì„ ì·¨ì†Œ(0ì›)í–ˆìŠµë‹ˆë‹¤.");
  });

  $("#btnConfirmBid")?.addEventListener("click", doConfirmBid);
  $("#btnCancelBid")?.addEventListener("click", doCancelBid);
  $("#btnConfirmBidMobile")?.addEventListener("click", doConfirmBid);
  $("#btnCancelBidMobile")?.addEventListener("click", doCancelBid);

  // ë¼ìš´ë“œ ê²°ê³¼ í† ìŠ¤íŠ¸
  onSnapshot(ref,(s)=>{
    if(!s.exists()) return;
    const d=s.data();
    if((d.resultRound||0) <= lastSeenResultRound) return;
    lastSeenResultRound = d.resultRound||0;

    const winners = Array.isArray(d.lastWinners)? d.lastWinners : [];
    const wasPart = Array.isArray(d.participantsBackup) ? d.participantsBackup.includes(myName)
                    : Array.isArray(d.participants) ? d.participants.includes(myName) : null;

    if (winners.includes(myName)) toast(`ë‚™ì°°! (${d.lastItem||d.currentItem||""})`, RESULT_IMG.success);
    else if (wasPart===true)      toast(`ì…ì°° ì‹¤íŒ¨(í™˜ë¶ˆ ì™„ë£Œ)`, RESULT_IMG.fail);
    else                          toast(`ë¶ˆì‘ì°° ë¼ìš´ë“œ ì¢…ë£Œ.`);
  });

  // ë°©ì¥: ê²Œì„ ì¢…ë£Œ ë²„íŠ¼
  $("#btnEndGame")?.addEventListener("click", async ()=>{
    if(!isHost){ toast("ë°©ì¥ë§Œ ê²Œì„ì„ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    if(!confirm("ì •ë§ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try{
      await updateDoc(ref,{ gameOver:true, endedAt:serverTimestamp(), updatedAt:serverTimestamp() });
      toast("ê²Œì„ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
    }catch(e){ toast(`ì¢…ë£Œ ì‹¤íŒ¨: ${e.message||e}`); }
  });

  // 5ë¶„ë§ˆë‹¤ ë¹„í™œì„± ë°© ì •ë¦¬
  setInterval(async ()=>{
    try{
      const s=await getDoc(ref);
      if(s.exists()){
        const d=s.data();
        if(!d.gameOver && isStale(d)){
          await deleteDoc(ref);
        }
      }
    }catch(_){}
  }, 5 * 60 * 1000);
</script>
</body>
</html>
